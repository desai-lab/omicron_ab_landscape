---
title: "Omicron_ACE2_Landscape"
author: "Alief Moulana"
date: "4/27/2022"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(ggplot2)
library(RColorBrewer)
library(stringr)
library(gtools)
library(ggpmisc)
library(tidyr)
library(dplyr)
library(ggnewscale)
library(ggrepel)
library(paletteer)
library(cowplot)
library(Rmisc)
library(scales)
library(ggtext)
```

## Load the Data
Before running any chunk to generate figures, load all required datasets. This is to ensure you have downloaded all the datasets in the `data` category.
```{r Data_Loading}
###Mutation Dictionary###
n <- 1:15 #initialize 15 mutations
nn <- c(339, 371, 373, 375, 417, 440, 446, 477, 478, 484, 493, 496, 498, 501, 505) #initialize the correct numbering for the mutations
nn.muts <- c("G339D","S371L","S373P","S375F","K417N","N440K","G446S","S477N","T478K","E484A","Q493R","G496S","Q498R","N501Y","Y505H")
AppendMe <- function(dfNames) {
  do.call(rbind, lapply(dfNames, function(x) {
    cbind(get(x), Antibody = x)
  }))
}
###KD Data###
#initialize, get Kd data

CoV555 <- read.table(file = 'data/cleaned_Kds_RBD_CoV555_proper.csv', sep = ',', 
                  header = TRUE,
                  colClasses=c("numeric","character",rep("numeric",57),"logical","logical")
                  ) %>% select(geno,log10Kd_pinned,err_log10Kd,is_non_binder,is_clean)
Kds.CoV555 <- CoV555  

S309 <- read.table(file = 'data/cleaned_Kds_RBD_S309_proper.csv', sep = ',', 
                  header = TRUE,
                  colClasses=c("numeric","character",rep("numeric",65),"logical","logical")
                  ) %>% select(geno,log10Kd_pinned,err_log10Kd,is_non_binder,is_clean)
Kds.S309 <- S309  

CB6 <- read.table(file = 'data/cleaned_Kds_RBD_CB6_proper.csv', sep = ',', 
                  header = TRUE,
                  colClasses=c("numeric","character",rep("numeric",61),"logical","logical")
                  ) %>% select(geno,log10Kd_pinned,err_log10Kd,is_non_binder,is_clean)
Kds.CB6 <- CB6  

REGN10987 <- read.table(file = 'data/cleaned_Kds_RBD_REGN10987_proper.csv', sep = ',', 
                  header = TRUE,
                  colClasses=c("numeric","character",rep("numeric",63),"logical","logical")
                  ) %>% select(geno,log10Kd_pinned,err_log10Kd,is_non_binder,is_clean)
Kds.REGN10987<- REGN10987  

Kds_ACE2 <- read.table(file = 'data/cleaned_Kds_RBD_ACE2_low_filter.tsv', sep = '\t', 
                  header = TRUE, 
                  colClasses=c("character",rep("numeric",45))
                  ) %>% 
  select(geno,log10Kd_pinned,err_log10Kd) %>%
  mutate(Antibody = "ACE2")
ACE2 <- Kds_ACE2[,1:3]
ACE2$is_non_binder <- FALSE
ACE2$is_clean <- TRUE
Kds.ACE2 <- ACE2

Kds.all <- AppendMe(c("CoV555","S309","CB6","REGN10987","ACE2"))
Kds_simplified <- data.frame(Genotype=Kds.all$geno,
                             Log10Kd_unfiltered = Kds.all$log10Kd_pinned, 
                             Error = Kds.all$err_log10Kd,
                             Antibody = Kds.all$Antibody,
                             NonBinder = Kds.all$is_non_binder,
                             Filtered = Kds.all$is_clean) #drop most of the columns
Kds_simplified$Log10Kd <- ifelse((Kds_simplified$NonBinder),
                                 5.0,
                                 ifelse(Kds_simplified$Filtered,
                                        Kds_simplified$Log10Kd_unfiltered,
                                        NA))


Kds.short.tradeoff <- data.frame(Genotype = Kds_simplified[1:nrow(Kds.ACE2),]$Genotype,
                                 ACE2 = subset(Kds_simplified,Antibody=="ACE2")$Log10Kd,
                                 CB6 = subset(Kds_simplified,Antibody=="CB6")$Log10Kd,
                                 CoV555 = subset(Kds_simplified,Antibody=="CoV555")$Log10Kd,
                                 REGN10987 = subset(Kds_simplified,Antibody=="REGN10987")$Log10Kd,
                                 S309 = subset(Kds_simplified,Antibody=="S309")$Log10Kd)


###Epistasis Data###
CoV555 <- read.delim("data/555_aic_6order_biochem.txt" ,skip = 1,header = TRUE, sep = "\t", dec = ".")
S309<- read.delim("data/S309_aic_4order_biochem.txt" ,skip = 1,header = TRUE, sep = "\t", dec = ".") 
CB6 <- read.delim("data/CB6_aic_3order_biochem.txt" ,skip = 1,header = TRUE, sep = "\t", dec = ".") 
REGN10987 <- read.delim("data/REGN_aic_5order_biochem.txt" ,skip = 1,header = TRUE, sep = "\t", dec = ".") 
epistasis.biochem <- AppendMe(c("CoV555","S309","CB6","REGN10987"))
#epistasis.stat <- read.delim("data/ACE2_4order_stat.txt",skip = 2,header = TRUE, sep = "\t", dec = ".")
epistasis.biochem$Order <- ifelse(epistasis.biochem$Term == "Intercept",0,str_count(epistasis.biochem$Term, pattern = ",")+1)
#epistasis.stat$Order <- ifelse(epistasis.stat$Term == "Intercept",0,str_count(epistasis.stat$Term, pattern = ",")+1)
epistasis.biochem <- separate(data = epistasis.biochem, col = Term, into = c("Term 1", "Term 2", "Term 3", "Term 4","Term 5","Term 6"), sep = ",")
epistasis.biochem[,1:6] <- apply(epistasis.biochem[,1:6],2,mapvalues,from=n,to=nn.muts)
epistasis.biochem[,1:6]<- lapply(epistasis.biochem[,1:6], function(X){ordered(X,levels = nn.muts,labels=nn.muts)})

#epistasis.stat <- separate(data = epistasis.stat, col = Term, into = c("Term 1", "Term 2", "Term 3", "Term 4"), sep = ",")
#epistasis.stat[,1:4] <- apply(epistasis.stat[,1:4],2,mapvalues,from=n,to=nn.muts)
#epistasis.stat[,1:4]<- lapply(epistasis.stat[,1:4], function(X){ordered(X,levels = nn.muts,labels=nn.muts)})

###Structure Data for Epistasis###
#first.structure <- read.delim("data/firstorder_structure_summaryACE2.csv" ,header = TRUE, sep = ",", dec = ".")
#second.structure <- read.delim("data/2ndorder_structure_summaryACE2.csv" ,header = TRUE, sep = ",", dec = ".")

###Data for Delta Delta Delta G###
#delta.G.vs.immune <- read.delim("data/deltadeltadeltag.csv" ,header = TRUE, sep = ",", dec = ".")

###Probability Data###
#probability <- read.delim("data/proba_order_mut_above_wuhan_withx.csv" ,header = TRUE, sep = ",", dec = ".")
#strong.probability <- read.delim("data/proba_order_strong_selection.csv" ,header = TRUE, sep = ",", dec = ".")
#three.way <- read.delim("data/probability_three_mutations.csv" ,header = TRUE, sep = ",", dec = ".")
#gisaid.mean <-read.delim("data/gisaid_fig1_data_withx.csv" ,header = TRUE, sep = ",", dec = ".")
#gisaid.N501Y <-read.delim("data/gisaid_fig2_data_withx.csv" ,header = TRUE, sep = ",", dec = ".")
```

```{r prepping_figure1c}
Kds_simplified$Antibody <- factor(Kds_simplified$Antibody, levels = c("CB6","CoV555","REGN10987","S309","ACE2"))
Kds_simplified[paste0('Mutation ', nn)] <- purrr::map_dfc(n, 
                                                     ~case_when(substr(Kds_simplified$Genotype,.x,.x) == '0' ~ '0',
                                                                substr(Kds_simplified$Genotype,.x,.x) == '1' ~ '1'
                                                     )
) #create columns that correspond to the allele for each mutation
Kds_simplified[paste0('Mutation ', nn)] <- lapply(Kds_simplified[paste0('Mutation ', nn)], factor) #factorize (object type) the mutations
wuhan.Kd <- data.frame(Antibody=c("CoV555","S309","CB6","REGN10987","ACE2"),
                       Kd=Kds_simplified[Kds_simplified$Genotype==
                             paste(replicate(length(n), "0"), collapse =
                                     ""),"Log10Kd"])
omicron.Kd <- data.frame(Antibody=c("CoV555","S309","CB6","REGN10987","ACE2"),
                         Kd=Kds_simplified[Kds_simplified$Genotype==
                             paste(replicate(length(n), "1"), collapse =
                                     ""),"Log10Kd"])
Kds_simplified$Class <- str_count(Kds_simplified$Genotype,"1") #initialize variable "Class", which is #hamming distance from Wuhan
Kds_simplified$Class <- ordered(Kds_simplified$Class, levels = as.character(0:15)) #order em

#getsomepalettes
getYellowtoRed <- colorRampPalette(c('#ffffcc','#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#bd0026','#800026'))
getPalettePairedLong = colorRampPalette(c('#121212','#808080','#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99','#b15928','#4f1530'))
binarypermutations <- function(n, vals = 0:1){
  tmp <- rep(list(vals), n)
  var <- do.call(expand.grid, tmp)
  return(apply(var, 1, paste0, collapse=''))
} #create a function that generates all possible 15-tuple permutations between 0 and 1

insertstr <- function(x,y,when){
  a <- x[1]
  b <- y
  return(paste(substr(a,1,when-1),b,substr(a,when,nchar(a)),sep=""))
} #create a function that inserts some character or string into another string in the first column of a dataframe at a specific position
antibodies <- c("CB6","CoV555","REGN10987","S309")

for(i in c(antibodies,"ACE2")){
  Kds.temp <- subset(Kds_simplified,Antibody==i)
  Kds_mutational_effects <- data.frame(Genotype = binarypermutations(14)) #create a dataframe
  Kds_mutational_effects[paste0('Mutation ',nn,"_0")] <- purrr::map_dfc(n, 
                                                            ~with(Kds.temp, Log10Kd[match(
                                                              apply(Kds_mutational_effects,1,insertstr,when=.x,y="0"), Genotype)])
                                                          )  #create a variable of Kd values where at a specific locus, the allele = 0
  Kds_mutational_effects[paste0('Mutation ',nn,"_1")] <- purrr::map_dfc(n, 
                                                            ~with(Kds.temp, Log10Kd[match(
                                                              apply(Kds_mutational_effects,1,insertstr,when=.x,y="1"), Genotype)])
                                                          ) #create a variable of Kd values where at a specific locus, the allele = 1
  Kds_mutational_effects[paste0('Effect_ ',nn)] <- purrr::map_dfc(nn, 
                                                            ~Kds_mutational_effects[paste0('Mutation ',.x,"_1")]-
                                                              Kds_mutational_effects[paste0('Mutation ',.x,"_0")])
  Kds_mutational_effects[paste0('Effect_error_',nn)] <- purrr::map_dfc(n, 
                                                            ~sqrt(
                                                              (with(get(paste0("Kds.",i)), err_log10Kd[match(
                                                              apply(Kds_mutational_effects,1,insertstr,when=.x,y="1"), geno)]))^2+
                                                              (with(get(paste0("Kds.",i)), err_log10Kd[match(
                                                              apply(Kds_mutational_effects,1,insertstr,when=.x,y="0"), geno)]))^2
                                                            )
                                                          )
  #create a set of variables for the difference (mutational effects) and its errors
  Kds_mutational_effects.long <- reshape(Kds_mutational_effects, direction="long", 
          varying=list(paste0('Mutation ',nn,"_0"), paste0('Mutation ',nn,"_1"), paste0('Effect_ ',nn),paste0('Effect_error_',nn)), 
          v.names=c("KD WT","KD OM","KD Effect","Effect Error")) #make the dataframe long. It's not possible to do it above, because of matrix optim
  Kds_mutational_effects.long$Mutation <- as.factor(Kds_mutational_effects.long$time) #create a new variable called mutation, denoting mutational identity we consider in each effect
  levels(Kds_mutational_effects.long$Mutation) <- nn.muts #renaming the levels of the factor
  assign(paste0("Kds_mutational_effects.long.", i),Kds_mutational_effects.long)
  Kx.temp <- get(paste0("Kds_mutational_effects.long.", i))
  Kx.temp$Antibody <- i
  assign(paste0("Kds_mutational_effects.long.", i),Kx.temp)
}


Kds_mutational_effects.long.all.abs <- rbind(Kds_mutational_effects.long.CoV555,
                                     Kds_mutational_effects.long.S309,
                                     Kds_mutational_effects.long.CB6,
                                     Kds_mutational_effects.long.REGN10987,
                                     Kds_mutational_effects.long.ACE2)
data_summary <- function(x) {
   m <- mean(x)
   ymin <- m-sd(x)
   ymax <- m+sd(x)
   return(c(y=m,ymin=ymin,ymax=ymax))
}

Kds_mutation_effects.long.filtered <- subset(Kds_mutational_effects.long.all.abs,
                                             `KD WT` > 6)
```

## Figure 1 - General Landscape
Figure 1: General Landscape.
```{r histogram}
antibody.colors <- c(getPalettePairedLong(15)[4],getPalettePairedLong(15)[6],
                     getPalettePairedLong(15)[8],getPalettePairedLong(15)[10])
Kds_simplified$Log10Kd.nb <- ifelse(Kds_simplified$Log10Kd < 6.01, 5.15, Kds_simplified$Log10Kd)
omicron.Kd$Kd <- ifelse(omicron.Kd$Kd < 6.01, 5.15, omicron.Kd$Kd)
Kds_simplified.withACE2 <- Kds_simplified
Kds_simplified.withoutACE2 <- subset(Kds_simplified,Antibody %in% antibodies)
Kds_simplified.withoutACE2$Antibody <- factor(Kds_simplified.withoutACE2$Antibody,levels=antibodies)
Kds_simplified.withoutACE2$Antibody.used <- ifelse(Kds_simplified.withoutACE2$Antibody=="CB6","LY-CoV016",
                                             ifelse(Kds_simplified.withoutACE2$Antibody=="CoV555",
                                                    "LY-CoV555",
                                                    as.character(Kds_simplified.withoutACE2$Antibody)))
  
Kds_simplified.withoutACE2$Antibody.used<-factor(Kds_simplified.withoutACE2$Antibody.used,
                                             levels = c("LY-CoV016","LY-CoV555","REGN10987","S309")
)


wuhan.Kd$Antibody.used <- ifelse(wuhan.Kd$Antibody=="CB6","LY-CoV016",
                                             ifelse(wuhan.Kd$Antibody=="CoV555",
                                                    "LY-CoV555",
                                                    as.character(wuhan.Kd$Antibody)))
  
wuhan.Kd$Antibody.used<-factor(wuhan.Kd$Antibody.used,
                                             levels = c("LY-CoV016","LY-CoV555","REGN10987","S309")
)

omicron.Kd$Antibody.used <- ifelse(omicron.Kd$Antibody=="CB6","LY-CoV016",
                                             ifelse(omicron.Kd$Antibody=="CoV555",
                                                    "LY-CoV555",
                                                    as.character(omicron.Kd$Antibody)))
  
omicron.Kd$Antibody.used<-factor(omicron.Kd$Antibody.used,
                                             levels = c("LY-CoV016","LY-CoV555","REGN10987","S309")
)

###Plot FIGURE 1A###
ggplot(Kds_simplified.withoutACE2, aes(x=Log10Kd.nb))+
  geom_histogram( position="identity",bins=40,  size = 0,alpha=1,fill="#333333")+
  labs(x=expression(-log~italic(K)[paste("D", ",", "app")])) +
  ylab("Count") +
  theme_classic()+
  #geom_vline(aes(xintercept = wuhan.Kd), colour = brewer.pal(n = 8, name = "Set1")[2],size=1.5)+
  #geom_vline(aes(xintercept = omicron.Kd), colour = brewer.pal(n = 8, name = "Set1")[1],size=1.5)+
  scale_x_continuous(breaks=c(5.15,6:11),labels=c("NB",6:11))+
  #ylim(0,16000)+
  facet_grid(.~Antibody.used)+
  geom_vline(data=wuhan.Kd[1:4,],aes(xintercept = Kd), 
             colour = brewer.pal(n = 8, name = "Set1")[2],
             linetype = "dashed",
             size=0.5)+
  geom_vline(data=omicron.Kd[1:4,],aes(xintercept = Kd), 
             colour = brewer.pal(n = 8, name = "Set1")[1],
             linetype = "dashed",
             size=0.5)+
  theme(axis.text.x = element_text(angle = 0,colour="black"),
        axis.text.y = element_text(colour="black"),
        axis.text=element_text(size=12),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        panel.grid.minor.x = element_blank(),
        legend.position = "none",
        panel.spacing = unit(0.9, "lines"),
        strip.text.x = element_text(size = 12))

ggsave("figures/Figure1_histogram_distribution_of_Kds_all_abs.png", width = 7.5, height = 2, units = "in")
```

the summary table
```{r summary table}
Kds_effect_summarized <- Kds_mutation_effects.long.filtered %>%
  select(`KD Effect`, Mutation, Antibody)%>%
  group_by(Mutation,Antibody) %>% 
  summarize(Mean = mean(`KD Effect`,na.rm=TRUE),
            Std = sd(`KD Effect`,na.rm=TRUE))

Kds_effect_summarized$Antibody <- factor(Kds_effect_summarized$Antibody, levels=c(antibodies,"ACE2"))

Kds_effect_summarized_just_mean <- Kds_effect_summarized%>%
  select(Mutation, Antibody,Mean)%>%
  pivot_wider(names_from = Mutation, values_from = Mean)
Kds_effect_summarized_just_mean$Antibody <- factor(Kds_effect_summarized_just_mean$Antibody, levels=c(antibodies,"ACE2"))

Kds_effect_summarized$Antibody.used <- ifelse(Kds_effect_summarized$Antibody=="CB6","LY-CoV016",
                                             ifelse(Kds_effect_summarized$Antibody=="CoV555",
                                                    "LY-CoV555",
                                                    as.character(Kds_effect_summarized$Antibody)))
  
Kds_effect_summarized$Antibody.used<-factor(Kds_effect_summarized$Antibody.used,
                                             levels = c("ACE2",rev(c("LY-CoV016","LY-CoV555","REGN10987","S309")))
)
#Mean heatmap
ggplot(Kds_effect_summarized) + 
  geom_tile(mapping=aes(x=`Mutation`, y=`Antibody.used`, fill= `Mean`)) +
  scale_fill_gradient2(low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill=expression(paste("Mean Effect on",-log~italic(K)[paste("D", ",", "app")]," (-log M)")))+
  xlab("Mutation") +
  ylab("Antibody or ACE2") +
  theme_classic()+
  coord_equal()+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=10),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        legend.position="none",
        legend.key.height = unit(0.4, "in"),
        legend.justification = "top")

ggsave("figures/Figure1_summary_table_mean_effects_edit.png", width = 6, height = 3.5, units = "in")


#Sd heatmap
ggplot(Kds_effect_summarized) + 
  geom_tile(mapping=aes(x=`Mutation`, y=`Antibody`, fill= `Std`)) +
  scale_fill_gradient2(limits = c(0.05,1.5),low = "#FFFF33",
                       high = "#121212",
                       guide = "colorbar") + 
  labs(fill="Standard Deviation of Effect")+
  xlab("Mutation") +
  ylab("Antibody") +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        #legend.text=element_text(size=12),
        legend.title=element_text(size=11,hjust = 1, vjust = 0.8),
        axis.title=element_text(size=14),
        legend.position="bottom",
        legend.spacing.x = unit(0.2, 'cm'))
ggsave("figures/FigureS1_summary_table_std_effects.png", width = 6, height = 2.5, units = "in")

```

jitter plots
```{r jitter plots per ab}
###Plot FIGURE 1B###
color.antibodies <- getPalettePairedLong(15)[c(4,6,10,12)]
#CB6
ggplot(subset(Kds_simplified,Antibody=="CB6"), aes(x=Class, y = Log10Kd.nb))+
  #geom_violin() +
  geom_jitter(height = 0.15, width = 0.3, size=0.8,alpha = 0.4,aes(color = `Mutation 417`,fill=`Mutation 417`))+
  #geom_jitter(height = 0.05, width = 0.3, size=0.8,alpha = 0.4)+
  #geom_violin(width=1.4) +
  geom_boxplot(width=0.7, color="#484848",alpha=0.4, outlier.alpha = 0.0,size=0.5) +
  #scale_fill_manual(values = getYellowtoRed(16))+
  #geom_density(alpha=.2, fill="#FF6666") +
  xlab("Number of Mutations") +
  labs(y=expression(-log~italic(K)[paste("D", ",", "app")]~"LY-CoV016"),color="K417N",fill="K417N") +
  theme_classic()+
  scale_color_manual(labels=c("1" = "N", 
                            "0" = "K"),values = color.antibodies)+
  scale_fill_manual(labels=c("1" = "N", 
                            "0" = "K"),values = color.antibodies)+
  #scale_color_manual(values = color.antibodies)+
  scale_y_continuous(limits =c(5,11),breaks=c(5.2,6:11),labels=c("NB",6:11))+
  theme(axis.text.x = element_text(angle = 0,colour="black",size=11),
        axis.text.y = element_text(colour="black",size=12),
        legend.text=element_text(size=10),
        legend.title=element_text(size=10),
        legend.position = "top",
        axis.title=element_text(size=13),
        legend.spacing = unit(4, "pt"), 
        legend.key.height = unit(8, "pt"), 
        legend.spacing.x = unit(4, "pt"), 
        legend.key.width  = unit(4, "pt"), 
        legend.margin=margin(4,4,4,4),
        legend.justification = "bottom",
        legend.box.spacing = margin(0.1))+
  guides(color=guide_legend(ncol=2),fill=guide_legend(ncol=2))+
  #facet_wrap(.~Antibody)+
  geom_hline(data=subset(wuhan.Kd,Antibody=="CB6"),
             aes(yintercept = Kd),colour = "black", linetype = "dashed")

ggsave("figures/Figure1_boxplot_and_jitters_Kds_across_numb_mutations_CB6_double_fragmented.png", width = 3.75, height = 2.5, units = "in")

#REGN10987
ggplot(subset(Kds_simplified,Antibody=="REGN10987"), aes(x=Class, y = Log10Kd.nb))+
  #geom_violin() +
  geom_jitter(height = 0.15, width = 0.3, size=0.8,alpha = 0.4,aes(color = interaction(`Mutation 440`,
                                                                          `Mutation 446`,sep="/",
                                                                          lex.order=TRUE),
                                                      fill = interaction(`Mutation 440`,
                                                                          `Mutation 446`,sep="/",
                                                                          lex.order=TRUE)))+
  geom_boxplot(width=0.7, color="#484848",alpha=0.4, outlier.alpha = 0.0,size=0.5) +
  #ylim(6,11)+
  xlab("Number of Mutations") +
  labs(y=expression(-log~italic(K)[paste("D", ",", "app")]~"REGN10987"),color="N440K/G446S",fill="N440K/G446S") +
  theme_classic()+
  scale_color_manual(labels=c("0/0" = "N/G", 
                            "1/0" = "K/G",
                            "0/1" = "N/S",
                            "1/1" = "K/S"),values = color.antibodies)+
  scale_fill_manual(labels=c("0/0" = "N/G", 
                            "1/0" = "K/G",
                            "0/1" = "N/S",
                            "1/1" = "K/S"),values = color.antibodies)+
  #scale_color_manual(values = color.antibodies)+
  scale_y_continuous(limits =c(5,11),breaks=c(5.2,6:11),labels=c("NB",6:11))+
  theme(axis.text.x = element_text(angle = 0,colour="black",size=11),
        axis.text.y = element_text(colour="black",size=12),
        legend.text=element_text(size=10),
        legend.title=element_text(size=10),
        legend.position = "top",
        axis.title=element_text(size=13),
        legend.spacing = unit(4, "pt"), 
        legend.key.height = unit(8, "pt"), 
        legend.spacing.x = unit(4, "pt"), 
        legend.key.width  = unit(4, "pt"), 
        legend.margin=margin(4,4,4,4),
        legend.justification = "bottom",
        legend.box.spacing = margin(0.1))+
  guides(color=guide_legend(ncol=2),fill=guide_legend(ncol=2))+
  #facet_wrap(.~Antibody)+
  geom_hline(data=subset(wuhan.Kd,Antibody=="REGN10987"),
             aes(yintercept = Kd),colour = "black", linetype = "dashed")

ggsave("figures/Figure1_boxplot_and_jitters_Kds_across_numb_mutations_REGN10987_double_fragmented.png", width = 3.75, height = 2.5, units = "in")

#CoV555
ggplot(subset(Kds_simplified,Antibody=="CoV555"), aes(x=Class, y = Log10Kd.nb))+
  #geom_violin() +
  geom_jitter(height = 0.15, width = 0.3, size=0.8,alpha = 0.4,aes(color = interaction(`Mutation 484`,
                                                                          `Mutation 493`,sep="/",
                                                                          lex.order=TRUE),
                                                      fill = interaction(`Mutation 484`,
                                                                          `Mutation 493`,sep="/",
                                                                          lex.order=TRUE)))+
  geom_boxplot(width=0.7, color="#484848",alpha=0.4, outlier.alpha = 0.0,size=0.5) +
  #ylim(6,11)+
  xlab("Number of Mutations") +
  labs(y=expression(-log~italic(K)[paste("D", ",", "app")]~"LY-CoV555"),color="E484A/Q493R",fill="E484A/Q493R") +
  theme_classic()+
  scale_color_manual(labels=c("0/0" = "E/Q", 
                            "1/0" = "A/Q",
                            "0/1" = "E/R",
                            "1/1" = "A/R"),values = color.antibodies)+
  scale_fill_manual(labels=c("0/0" = "E/Q", 
                            "1/0" = "A/Q",
                            "0/1" = "E/R",
                            "1/1" = "A/R"),values = color.antibodies)+
  #scale_color_manual(values = color.antibodies)+
  scale_y_continuous(limits =c(5,11),breaks=c(5.2,6:11),labels=c("NB",6:11))+
  theme(axis.text.x = element_text(angle = 0,colour="black",size=11),
        axis.text.y = element_text(colour="black",size=12),
        legend.text=element_text(size=10),
        legend.title=element_text(size=10),
        legend.position = "top",
        axis.title=element_text(size=13),
        legend.spacing = unit(4, "pt"), 
        legend.key.height = unit(8, "pt"), 
        legend.spacing.x = unit(4, "pt"), 
        legend.key.width  = unit(4, "pt"), 
        legend.margin=margin(4,4,4,4),
        legend.justification = "bottom",
        legend.box.spacing = margin(0.1))+
  guides(color=guide_legend(ncol=2),fill=guide_legend(ncol=2))+
  #facet_wrap(.~Antibody)+
  geom_hline(data=subset(wuhan.Kd,Antibody=="CoV555"),
             aes(yintercept = Kd),colour = "black", linetype = "dashed")

ggsave("figures/Figure1_boxplot_and_jitters_Kds_across_numb_mutations_CoV555_double_fragmented.png", width = 3.75, height = 2.5, units = "in")

#S309
ggplot(subset(Kds_simplified,Antibody=="S309"), aes(x=Class, y = Log10Kd.nb))+
  geom_jitter(height = 0.05, width = 0.3, size=0.8,alpha = 0.4,color=color.antibodies[1])+
  #geom_jitter(height = 0.05, width = 0.3, size=0.8,alpha = 0.4,color=color.antibodies[1],fill=color.antibodies[1])+
  geom_boxplot(width=0.7, color="#484848",alpha=0.4, outlier.alpha = 0.0,size=0.5) +
  xlab("Number of Mutations") +
  labs(y=expression(-log~italic(K)[paste("D", ",", "app")]~"S309")) +
  theme_classic()+
  #scale_color_manual(values = color.antibodies)+
  scale_y_continuous(limits =c(5,11),breaks=c(5.2,6:11),labels=c("NB",6:11))+
  theme(axis.text.x = element_text(angle = 0,colour="black",size=11),
        axis.text.y = element_text(colour="black",size=12),
        legend.text=element_text(size=10),
        legend.title=element_text(size=10),
        legend.position = "top",
        axis.title=element_text(size=13),
        legend.spacing = unit(4, "pt"), 
        legend.key.height = unit(8, "pt"), 
        legend.spacing.x = unit(4, "pt"), 
        legend.key.width  = unit(4, "pt"), 
        legend.margin=margin(4,4,4,4),
        legend.justification = "bottom",
        legend.box.spacing = margin(0.1))+
  #facet_wrap(.~Antibody)+
  #ylim(6,11)+
  #scale_y_continuous(breaks=6:11,labels=c("NB",7:11))+
  geom_hline(data=subset(wuhan.Kd,Antibody=="S309"),
             aes(yintercept = Kd),colour = "black", linetype = "dashed")

ggsave("figures/Figure1_boxplot_and_jitters_Kds_across_numb_mutations_S309_double_fragmented.png", width = 3.75, height = 2.5, units = "in")

###Plot FIGURE 1C###
for(i in antibodies){
  Kds_mutational_effects.long<-subset(Kds_mutational_effects.long.all.abs,
                                      Antibody==i)
  ggplot(Kds_mutational_effects.long, aes(x=Mutation, y = `KD Effect`))+
    #geom_jitter(height = 0.2, width = 0.2, size=0.1,alpha = 0.1, color="#b9b9b9",aes( fill = Mutation))+
    geom_boxplot(width=0.5, aes(fill=Mutation), color ="#333333",alpha = 0.75, size =0.25,outlier.shape=NA) +
    #stat_summary(fun.data=data_summary,geom="pointrange", size=0.25,color="black")+
    #geom_boxplot(width=0.15, color="#333333", alpha = 0.5) +
    geom_point(data=Kds_mutational_effects.long[Kds_mutational_effects.long$Genotype==strrep('0',14),],
               aes(x=Mutation, y = `KD Effect`),position = position_nudge(x = -0.15),size=1.5,
               colour = brewer.pal(n = 8, name = "Set1")[2])+ #also distinctively color the point that corresponds to wuhan background
    geom_errorbar(data=Kds_mutational_effects.long[Kds_mutational_effects.long$Genotype==strrep('0',14),],
                  aes(ymin=`KD Effect`-`Effect Error`, ymax=`KD Effect`+`Effect Error`), width=.01,
                  position = position_nudge(x = -0.15),colour = brewer.pal(n = 8, name = "Set1")[2])+
    geom_point(data=Kds_mutational_effects.long[Kds_mutational_effects.long$Genotype==strrep('1',14),],
               aes(x=Mutation, y = `KD Effect`),position = position_nudge(x = 0.15),size=1.5,
               colour = brewer.pal(n = 8, name = "Set1")[1])+ #also distinctively color the point that corresponds to om background
    geom_errorbar(data=Kds_mutational_effects.long[Kds_mutational_effects.long$Genotype==strrep('1',14),],
                  aes(ymin=`KD Effect`-`Effect Error`, ymax=`KD Effect`+`Effect Error`), width=.01,
                  position = position_nudge(x = 0.15),colour = brewer.pal(n = 8, name = "Set1")[1])+
    scale_color_manual(values = getPalettePairedLong(15))+
    scale_fill_manual(values = getPalettePairedLong(15))+
    scale_x_discrete(expand=c(0,0))+
    #ylim(-5,5)+
    xlab("Mutation") +
    labs(y=expression(Delta~(-log~italic(K)[paste("D", ",", "app")]))) +
    #geom_point(data=Kds_mutational_effects.long[Kds_mutational_effects.long$Genotype==strrep('1',14),],
    #           aes(x=Mutation, y = `KD Effect`),position = position_nudge(x = 0.15),size=1.5,
    #           colour = brewer.pal(n = 8, name = "Set1")[1])+
    theme_classic()+
    theme(axis.text.x = element_text(size=11,angle = 90,hjust = 1, vjust = 0.5),
          axis.text.y = element_text(size=12),
          axis.text=element_text(color="black"),
          legend.text=element_text(size=12),
          legend.title=element_blank(),
          axis.title=element_text(size=14),
          legend.position = "none")+
    geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")
  
  ggsave(paste0("figures/FigureS1_violin_and_jitters_Kd_effect_per_mutation_withoutanythingelse_trimmed_",i,".png"), width = 7.5, height = 3, units = "in")
}                                                    
```

##Figure 2 - Escape Mutations
```{r sufficient mutations}
Kds_mutation_effects.long.filtered <- subset(Kds_mutational_effects.long.all.abs,
                                             `KD WT` > 6)
binding.percentage <- data.frame(Mutation = nn.muts)

get.sum.binding <- function(x,ab){
  with(subset(Kds_mutation_effects.long.filtered,Antibody==ab),sum(Mutation==x & `KD OM` == 6)/sum(Mutation==x))
}

get.sum.deleterious <- function(x,ab){
  with(subset(Kds_mutation_effects.long.filtered,Antibody==ab),sum(Mutation==x & `KD Effect` <0)/sum(Mutation==x))
  #with(subset(Kds_mutation_effects.long.filtered,Antibody==ab),
      # sum(Mutation==x & `KD Effect` <0 & (abs(`KD Effect`) + 0.05)> `Effect Error`,na.rm=TRUE)/sum(Mutation==x)) #only significant
}

binding.percentage$S309 <- apply(binding.percentage,1,get.sum.binding,ab="S309")
binding.percentage$CoV555 <- apply(binding.percentage,1,get.sum.binding,ab="CoV555")
binding.percentage$CB6 <- apply(binding.percentage,1,get.sum.binding,ab="CB6")
binding.percentage$REGN10987 <- apply(binding.percentage,1,get.sum.binding,ab="REGN10987")

deleterious.percentage <- data.frame(Mutation = nn.muts)
deleterious.percentage$S309 <- apply(deleterious.percentage,1,get.sum.deleterious,ab="S309")
deleterious.percentage$CoV555 <- apply(deleterious.percentage,1,get.sum.deleterious,ab="CoV555")
deleterious.percentage$CB6 <- apply(deleterious.percentage,1,get.sum.deleterious,ab="CB6")
deleterious.percentage$REGN10987 <- apply(deleterious.percentage,1,get.sum.deleterious,ab="REGN10987")

binding.percentage.long <- reshape(binding.percentage,direction="long",varying=list(antibodies))
binding.percentage.long$Antibody <- rep(antibodies,each=15)
binding.percentage.long$Mutation <- factor(binding.percentage.long$Mutation,levels=nn.muts)

deleterious.percentage.long <- reshape(deleterious.percentage,direction="long",varying=list(antibodies))
deleterious.percentage.long$Antibody <- rep(antibodies,each=15)
deleterious.percentage.long$Mutation <- factor(deleterious.percentage.long$Mutation,levels=nn.muts)

ggplot(deleterious.percentage.long, aes(x=Mutation, y=CB6*100, fill = Antibody))+
  geom_bar(stat='identity',color="#333333",position = position_dodge())+
  #geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
  #              position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_color_manual(values=getPalettePairedLong(6)[2:5])+
  geom_hline(yintercept=50,size=0.5,linetype = "dashed",color="black")+
  xlab("Mutation") +
  ylab(str_wrap("Percent Deleterious Effects", width = 30)) +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        axis.title.y=element_text(size=12))

ggsave("figures/Figure2SI_bars_percent_deleterious_effects_binders_only_significant.png", width = 7.5, height = 3.5, units = "in")

ggplot(subset(binding.percentage.long,Antibody!= "S309"), aes(x=Mutation, y=CB6*100, fill = Antibody))+
  geom_bar(stat='identity',color="#333333",width=0.7,position=position_dodge(0.7))+
  #geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
  #              position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_fill_manual(values=getPalettePairedLong(6)[2:5])+
  #geom_hline(yintercept=0.05,size=2,color="white")+
  xlab("Mutation") +
  ylab(str_wrap("Percent Non-Binding Effects", width = 25)) +
  theme_classic()+
  guides(fill = guide_legend(override.aes = list(size = 0.2)),
         color = guide_legend(override.aes = list(size = 0.2)))+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=8),
        legend.title=element_blank(),
        legend.position = "none",
        axis.title=element_text(size=14),
        axis.title.y=element_text(size=12),
        legend.key.size = unit(0.8, "lines"))

ggsave("figures/Figure2_bars_percent_non_effect_binders_is_it_sufficient.png", width = 3.75, height = 2.5, units = "in")


#xxx
x <- 1

```



```{r required mutations}
Kds.nonbinders <- subset(Kds_simplified,Log10Kd==6)
get.mean.nonbinders <- function(df){
  x <- df["Mutation"]
  ab <- df["Antibody"]
  mat <- subset(Kds.nonbinders,Antibody==ab)
  row <- mat[paste0("Mutation ",x)]
  mean(row=='1')
}

nonbinding.percentage <- data.frame(Mutation = factor(rep(as.character(nn),4),levels=nn),
                                    Antibody = factor(rep(antibodies,each=15),levels=antibodies),
                                    Antibody.used = factor(rep(c("LY-CoV016","LY-CoV555","REGN10987","S309"),
                                                          each=15),
                                                      levels=c("LY-CoV016","LY-CoV555","REGN10987","S309")))


nonbinding.percentage$Proportion <- apply(nonbinding.percentage,1,get.mean.nonbinders)
nonbinding.percentage$Mutation <- factor(rep(nn.muts,4),levels = nn.muts)

ggplot(subset(nonbinding.percentage,Antibody.used != "S309"), aes(x=Mutation, y=Proportion*100, fill = Antibody.used))+
  geom_bar(stat='identity',color="#333333",width=0.7,position=position_dodge(0.7))+
  #geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
  #              position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_fill_manual(values=getPalettePairedLong(6)[2:5])+
  geom_hline(yintercept=50,size=0.5,linetype = "dashed",color="black")+
  xlab("Mutation") +
  ylab(str_wrap("Frequency amongst Non-Binders", width = 20)) +
  theme_classic()+
  guides(fill = guide_legend(override.aes = list(size = 0.15),ncol=2),
         color = guide_legend(override.aes = list(size = 0.15),ncol=2))+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=8),
        legend.title=element_blank(),
        legend.position = c(.77,0.9),
        axis.title=element_text(size=14),
        axis.title.y=element_text(size=12),
        legend.key.size = unit(0.4, "lines"))

ggsave("figures/Figure2_bars_percent_mutated_in_non_binders_required.png", width = 4, height = 2.5, units = "in")

get.nonbinder.percentage.per.mutation <- function(df){
  x <- df["Mutation"]
  ab <- df["Antibody"]
  mat <- subset(Kds_simplified,Antibody==ab)
  row <- subset(mat,get(paste0("Mutation ",x))=='1')['Log10Kd']
  mean(row==6)
}

nonbinder.per.mutations <- data.frame(Mutation = factor(rep(as.character(nn),4),levels=nn),
                                    Antibody = factor(rep(antibodies,each=15),levels=antibodies))


nonbinder.per.mutations$Proportion <- apply(nonbinder.per.mutations,1,get.nonbinder.percentage.per.mutation)
nonbinder.per.mutations <- subset(nonbinder.per.mutations,Antibody != "S309")

ggplot(nonbinder.per.mutations, aes(x=Mutation, y=Proportion*100, fill = Antibody))+
  geom_bar(stat='identity',color="#333333",position = position_dodge())+
  #geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
  #              position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_fill_manual(values = antibody.colors)+
  geom_hline(yintercept=50,size=0.7,linetype = "dashed",color="black")+
  geom_hline(yintercept=25,size=0.7,linetype = "dotted",color="black")+

  xlab("Mutation") +
  ylab(str_wrap("Percent Non-Binders when Mutated", width = 30)) +
  theme_classic()+
  guides(fill = guide_legend(override.aes = list(size = 0.5)))+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        axis.title.y=element_text(size=12))

ggsave("figures/FigureSI2_bars_percent_non_binders_when_mutated.png", width = 7.5, height = 3.5, units = "in")
```

###Decision tree
```{r decision tree}
# Modeling packages
library(rpart)       # direct engine for decision tree application
library(caret)       # meta engine for decision tree application

# Model interpretability packages
library(rpart.plot)  # for plotting decision trees
library(vip)         # for feature importance
library(pdp)         # for feature effects
library(treeheatr)
library(partykit)
library(rattle)

Kds_simplified[paste0('Mutation_', nn)] <- Kds_simplified[paste0('Mutation ', nn)]
Kds_simplified[nn.muts] <- Kds_simplified[paste0('Mutation ', nn)]
Kds.abs <- subset(Kds_simplified,Antibody=="CoV555")
Kds.abs.CoV555 <- subset(Kds_simplified,Antibody=="CoV555")
Kds.abs.S309 <- subset(Kds_simplified,Antibody=="S309")
Kds.abs.CB6 <- subset(Kds_simplified,Antibody=="CB6")
Kds.abs.REGN10987 <- subset(Kds_simplified,Antibody=="REGN10987")

Kds.muts.REGN10987 <- select(Kds.abs.REGN10987,c('Log10Kd',nn.muts))
Kds.muts.CB6 <- select(Kds.abs.CB6,c('Log10Kd',nn.muts))
Kds.muts.CoV555 <- select(Kds.abs.CoV555,c('Log10Kd',nn.muts))
Kds.muts.S309 <- select(Kds.abs.S309,c('Log10Kd',nn.muts))

Kds.bind.REGN10987 <- Kds.muts.REGN10987
Kds.bind.CB6 <- Kds.muts.CB6
Kds.bind.CoV555 <- Kds.muts.CoV555
Kds.bind.S309 <- Kds.muts.S309

Kds.bind.REGN10987$Binds <- as.factor(ifelse(Kds.bind.REGN10987$Log10Kd == 6, "Non-Binding", "Binding"))
Kds.bind.CB6$Binds <- as.factor(ifelse(Kds.bind.CB6$Log10Kd == 6, "Non-Binding", "Binding"))
Kds.bind.CoV555$Binds <- as.factor(ifelse(Kds.bind.CoV555$Log10Kd == 6, "Non-Binding", "Binding"))
Kds.bind.S309$Binds <- as.factor(ifelse(Kds.bind.S309$Log10Kd == 6, "Non-Binding", "Binding"))

decision.tree.S309 <- rpart(
   formula = Log10Kd ~ G339D + S371L + S373P + S375F + K417N + N440K + G446S + 
    S477N + T478K + E484A + Q493R + G496S + Q498R + N501Y + Y505H ,
  data    = Kds.muts.S309
)

decision.tree.CoV555 <- rpart(
  formula = Binds ~ G339D + S371L + S373P + S375F + K417N + N440K + G446S + 
    S477N + T478K + E484A + Q493R + G496S + Q498R + N501Y + Y505H + 0*Log10Kd,
  data    = Kds.bind.CoV555
  #method  = "anova"
)
decision.tree.CB6 <- rpart(
  formula = Binds ~ G339D + S371L + S373P + S375F + K417N + N440K + G446S + 
    S477N + T478K + E484A + Q493R + G496S + Q498R + N501Y + Y505H + 0*Log10Kd,
  data    = Kds.bind.CB6
)
decision.tree.REGN10987 <- rpart(
  formula = Binds ~ G339D + S371L + S373P + S375F + K417N + N440K + G446S + 
    S477N + T478K + E484A + Q493R + G496S + Q498R + N501Y + Y505H + 0*Log10Kd,
  data    = Kds.bind.REGN10987
)

getBluetoRed <- colorRampPalette(c('#1F78B4','gray50','#E31A1C'))

#CoV555 histogram
Kds.muts.CoV555$decision <- case_when(
  (Kds.muts.CoV555$Q493R== "0" & 
    Kds.muts.CoV555$E484A == "0") ~ 1,
  (Kds.muts.CoV555$Q493R== "0" & 
     Kds.muts.CoV555$E484A == "1" &
     Kds.muts.CoV555$S375F == "0") ~ 2,
  (Kds.muts.CoV555$Q493R== "0" & 
     Kds.muts.CoV555$E484A == "1" &
     Kds.muts.CoV555$S375F == "1" &
     Kds.muts.CoV555$N501Y == "0" &
     Kds.muts.CoV555$S477N == "0") ~ 3,
  (Kds.muts.CoV555$Q493R== "0" & 
     Kds.muts.CoV555$E484A == "1" &
     Kds.muts.CoV555$S375F == "1" &
     Kds.muts.CoV555$N501Y == "0" &
     Kds.muts.CoV555$S477N == "1") ~ 4,
  (Kds.muts.CoV555$Q493R== "0" & 
     Kds.muts.CoV555$E484A == "1" &
     Kds.muts.CoV555$S375F == "1" &
     Kds.muts.CoV555$N501Y == "1") ~ 5,
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "0" &
     Kds.muts.CoV555$G446S == "0" &
     Kds.muts.CoV555$S375F == "0") ~ 6,
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "0" &
     Kds.muts.CoV555$G446S == "0" &
     Kds.muts.CoV555$S375F == "1" &
     Kds.muts.CoV555$N501Y == "0" ) ~ 7,
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "0" &
     Kds.muts.CoV555$G446S == "0" &
     Kds.muts.CoV555$S375F == "1" &
     Kds.muts.CoV555$N501Y == "1" ) ~ 8,
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "0" &
     Kds.muts.CoV555$G446S == "1" &
     Kds.muts.CoV555$N501Y == "0" &
     Kds.muts.CoV555$S375F == "0" ) ~ 9,
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "0" &
     Kds.muts.CoV555$G446S == "1" &
     Kds.muts.CoV555$N501Y == "0" &
     Kds.muts.CoV555$S375F == "1" ) ~ 10,
  
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "0" &
     Kds.muts.CoV555$G446S == "1" &
     Kds.muts.CoV555$N501Y == "1") ~ 11,
  (Kds.muts.CoV555$Q493R== "1" & 
     Kds.muts.CoV555$E484A == "1") ~ 12
)
Kds.muts.CoV555$decision <- factor(Kds.muts.CoV555$decision,levels=1:12)
Kds.muts.CoV555$Log10Kd.nb <- ifelse(Kds.muts.CoV555$Log10Kd == 6, 5.5, Kds.muts.CoV555$Log10Kd)
ggplot(Kds.muts.CoV555, aes(Log10Kd.nb)) + 
  facet_grid(.~decision)+
  geom_histogram(fill='grey40')+
  coord_flip()+
  labs(x=expression(-log~italic(K)[paste("D", ",", "app")])) +
  ylab("Count") +
  theme_bw()+
  scale_y_continuous(limits = c(0,800),breaks=c(0,250,500),labels=c(0,250,"500+"))+
  scale_x_continuous(breaks=c(5.5,6:11),labels=c("NB",6:11))+
  #xlim(6.000,11)+
  #geom_vline(aes(xintercept = wuhan.Kd), colour = brewer.pal(n = 8, name = "Set1")[2],size=1.5)+
  #geom_vline(aes(xintercept = omicron.Kd), colour = brewer.pal(n = 8, name = "Set1")[1],size=1.5)+
  theme(axis.text.x = element_text(angle = 270,colour="black",hjust = 0, vjust = 0.5),
        axis.text.y = element_text(colour="black"),
        axis.text=element_text(size=11),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=13),
        panel.grid.minor.x = element_blank(),
        legend.position = "none",
        panel.spacing = unit(0.7, "lines"),
        strip.text.x = element_blank())
ggsave("figures/Figure4_CoV555_histogram_bw.png", width = 6.5, height = 2, units = "in")

#REGN10987 histogram
Kds.muts.REGN10987$decision <- case_when(
  (Kds.muts.REGN10987$G446S== "0") ~ 1,
  (Kds.muts.REGN10987$G446S== "1" & 
     Kds.muts.REGN10987$N440K == "0") ~ 2,
  (Kds.muts.REGN10987$G446S== "1" & 
     Kds.muts.REGN10987$N440K == "1") ~ 3
)
Kds.muts.REGN10987$decision <- factor(Kds.muts.REGN10987$decision,levels=1:3)
Kds.muts.REGN10987$Log10Kd.nb <- ifelse(Kds.muts.REGN10987$Log10Kd == 6, 5.5, Kds.muts.REGN10987$Log10Kd)
ggplot(Kds.muts.REGN10987, aes(Log10Kd.nb)) + 
  facet_wrap(decision~., dir = "v")+
  geom_histogram(fill='grey40')+
  #coord_flip()+
  labs(x=expression(-log~italic(K)[paste("D", ",", "app")])) +
  ylab("Count") +
  theme_bw()+
  scale_y_log10(breaks=c(1,10,100,1000,10000),labels=c(1,"",100,"",10000),position="right")+
  scale_x_continuous(breaks=c(5.5,6:11),labels=c("NB",6:11))+
  #xlim(6.000,11)+
  #geom_vline(aes(xintercept = wuhan.Kd), colour = brewer.pal(n = 8, name = "Set1")[2],size=1.5)+
  #geom_vline(aes(xintercept = omicron.Kd), colour = brewer.pal(n = 8, name = "Set1")[1],size=1.5)+
  theme(axis.text.x = element_text(angle = 90,colour="black",hjust = 1, vjust = 0.5),
        axis.text.y = element_text(colour="black"),
        axis.text=element_text(size=10.5),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=13),
        panel.grid.minor.x = element_blank(),
        legend.position = "none",
        panel.spacing = unit(0.7, "lines"),
        strip.text.x = element_blank())
ggsave("figures/Figure4_REGN10987_histogram_bw.png", width = 2.4, height = 2.1, units = "in")

#CB6 histo
Kds.muts.CB6$decision <- case_when(
  (Kds.muts.CB6$K417N== "0") ~ 1,
  (Kds.muts.CB6$K417N== "1")~2
)
Kds.muts.CB6$decision <- factor(Kds.muts.CB6$decision,levels=1:2)
Kds.muts.CB6$Log10Kd.nb <- ifelse(Kds.muts.CB6$Log10Kd == 6, 5.5, Kds.muts.CB6$Log10Kd)
ggplot(Kds.muts.CB6, aes(Log10Kd.nb)) + 
  facet_wrap(decision~., dir = "v")+
  geom_histogram(fill='grey40')+
  #coord_flip()+
  labs(x=expression(-log~italic(K)[paste("D", ",", "app")])) +
  ylab("Count") +
  theme_bw()+
  scale_y_log10(breaks=c(1,10,100,1000,10000),labels=c(1,"",100,"",10000),position="right")+
  scale_x_continuous(breaks=c(5.5,6:11),labels=c("NB",6:11))+
  #xlim(6.000,11)+
  #geom_vline(aes(xintercept = wuhan.Kd), colour = brewer.pal(n = 8, name = "Set1")[2],size=1.5)+
  #geom_vline(aes(xintercept = omicron.Kd), colour = brewer.pal(n = 8, name = "Set1")[1],size=1.5)+
  theme(axis.text.x = element_text(angle = 90,colour="black",hjust = 1, vjust = 0.5),
        axis.text.y = element_text(colour="black"),
        axis.text=element_text(size=10.5),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=13),
        panel.grid.minor.x = element_blank(),
        legend.position = "none",
        panel.spacing = unit(0.7, "lines"),
        strip.text.x = element_blank())
ggsave("figures/Figure4_CB6_histogram_bw.png", width = 2.4, height = 1.6, units = "in")

```
## Figure 3--Epistasis and Alternative Pathways
Figure 3: Epistasis.
```{r epistasis data loading}
required.CoV555 <- c("E484A","Q493R")
required.REGN10987 <- c("N440K","G446S")
required.CB6 <- c("K417N")
biochem.first.order <- subset(epistasis.biochem,Order=="1")
#biochem.first.order <- biochem.first.order %>% 
#  mutate(Coefficient.Updated = case_when(
#    Antibody == "CoV555" & `Term 1` %in% required.CoV555 ~ -0.6,
#    Antibody == "CB6" & `Term 1` %in% required.CB6 ~ -0.6,
#    Antibody == "REGN10987" & `Term 1` %in% required.REGN10987 ~ -0.6,
#    Coefficient < -0.3 ~ Coefficient + 0.5,
#    TRUE ~ Coefficient
#  )
#)
antibody.colors <- c(getPalettePairedLong(15)[4],getPalettePairedLong(15)[6],
                     getPalettePairedLong(15)[8],getPalettePairedLong(15)[10])
biochem.first.order$Coefficient.nb <- ifelse(biochem.first.order$Coefficient > (-0.7),
                                             biochem.first.order$Coefficient,
                                             (biochem.first.order$Coefficient + 1) * .2/2 - 0.9)

epistasis.biochem$Coefficient.nb <- ifelse(epistasis.biochem$Standard.Error > 1, NA, epistasis.biochem$Coefficient)
#biochem.first.order$mask <- 0
#biochem.first.order$mask[biochem.first.order$Coefficient.Updated < (-0.4)] <- 1

#bunch of rearranging the terms and coefficients
summing_coefficient <- function(x,y){
  return(with(y, sum(Coefficient.nb[
    rowSums(x[1] == y,na.rm=TRUE) > 0  &
      rowSums(x[2] == y,na.rm=TRUE) > 0])
  ))
}

summing_coefficient <- function(x,y){
  return(with(y, sum(Coefficient.nb[
    rowSums(x[1] == y,na.rm=TRUE) > 0  &
      rowSums(x[2] == y,na.rm=TRUE) > 0])
  ))
}
abs_summing_coefficient <- function(x,y){
  return(with(y, sum(abs(Coefficient.nb[
    rowSums(x[1] == y,na.rm=TRUE) > 0  &
      rowSums(x[2] == y,na.rm=TRUE) > 0]))
  ))
}

summing_coefficient_to_one <- function(x,y){
  return(with(y, sum(Coefficient.nb[
    rowSums(x[1] == y,na.rm=TRUE) > 0 ],na.rm=TRUE)
  ))
}
epistasis.biochem.higher <- subset(epistasis.biochem,Order %in% c("3","4","5","6")) #higher order than 2
#epistasis.biochem.higher$one <- 1
epistasis.biochem.temp <- subset(epistasis.biochem,Order%in%c("1","2")) #only 2nd order

#epistasis.biochem.higher <- epistasis.biochem.higher %>% 
#  mutate(Coefficient = case_when(
#    Antibody == "CoV555" & (`Term 1` %in% required.CoV555 | 
#                            `Term 2` %in% required.CoV555 |
#                            `Term 3` %in% required.CoV555 |
#                            `Term 4` %in% required.CoV555)~ NA_real_,
#    Antibody == "CB6" & (`Term 1` %in% required.CB6 | 
#                            `Term 2` %in% required.CB6 |
#                            `Term 3` %in% required.CB6 |
#                            `Term 4` %in% required.CB6) ~ NA_real_,
#    Antibody == "REGN10987" & (`Term 1` %in% required.REGN10987 | 
#                            `Term 2` %in% required.REGN10987 |
#                            `Term 3` %in% required.REGN10987 |
#                            `Term 4` %in% required.REGN10987) ~ NA_real_,
#    TRUE ~ Coefficient
#  )
#)

#epistasis.biochem.temp <- epistasis.biochem.temp %>% 
#  mutate(Coefficient = case_when(
#    Antibody == "CoV555" & (`Term 1` %in% required.CoV555 | 
#                            `Term 2` %in% required.CoV555 |
#                            `Term 3` %in% required.CoV555 |
#                            `Term 4` %in% required.CoV555)~ NA_real_,
#    Antibody == "CB6" & (`Term 1` %in% required.CB6 | 
#                            `Term 2` %in% required.CB6 |
#                            `Term 3` %in% required.CB6 |
#                            `Term 4` %in% required.CB6) ~ NA_real_,
#    Antibody == "REGN10987" & (`Term 1` %in% required.REGN10987 | 
#                            `Term 2` %in% required.REGN10987 |
#                            `Term 3` %in% required.REGN10987 |
#                            `Term 4` %in% required.REGN10987) ~ NA_real_,
#    TRUE ~ Coefficient
#  )
#)

epistasis.temp.temp <- NULL
epistasis.temp.temp2 <- NULL
epistasis.temp.temp3 <- NULL
epistasis.temp.temp4 <- NULL
epistasis.temp.temp5 <- NULL
epistasis.temp.temp6 <- NULL

for(i in antibodies){
  epistasis.temp.higher<-subset(epistasis.biochem.higher,Antibody==i)
  epistasis.temp <- subset(epistasis.biochem.temp,Antibody==i)
  epistasis.temp.temp <- subset(epistasis.temp,Order=="2")

  epistasis.temp.temp$t1 <- epistasis.temp.temp$`Term 2`
  epistasis.temp.temp$t2 <- epistasis.temp.temp$`Term 1`
  epistasis.temp.temp$part <- "A"
  epistasis.temp.temp$second <- "Pairwise"
  
  
  epistasis.temp.temp2 <- subset(epistasis.temp.temp,Order=="2")
  epistasis.temp.temp2$`Term 1` <- epistasis.temp.temp2$t1
  epistasis.temp.temp2$`Term 2` <- epistasis.temp.temp2$t2
  #epistasis.temp.temp2$`Coefficient`<- apply(epistasis.temp.temp2,1,summing_coefficient,y=epistasis.temp.higher)
  epistasis.temp.temp2$part <- "B"
  epistasis.temp.temp2$second <- "Pairwise"
  
  epistasis.temp.temp3 <- subset(epistasis.temp,Order=="1")
  epistasis.temp.temp3$`Term 2` <- epistasis.temp.temp3$`Term 1`
  epistasis.temp.temp3$t1 <- NA
  epistasis.temp.temp3$t2 <- NA
  epistasis.temp.temp3$Coefficient.nb <- NA
  epistasis.temp.temp3$part <- "C"
  epistasis.temp.temp3$second <- "Pairwise"
  
  epistasis.temp.temp4 <- subset(epistasis.temp,Order=="1")
  epistasis.temp.temp4$`Term 2` <- "Higher"
  epistasis.temp.temp4$t1 <- NA
  epistasis.temp.temp4$t2 <- NA
  epistasis.temp.temp4$Coefficient.nb <-
    apply(epistasis.temp.temp4,1,summing_coefficient_to_one,y=epistasis.temp.higher)
  epistasis.temp.temp4$part <- "D"
  epistasis.temp.temp4$second <- ">2"
  
  epistasis.temp.df2 <- rbind(epistasis.temp.temp,epistasis.temp.temp2,epistasis.temp.temp3,epistasis.temp.temp4)
  epistasis.temp.df2$second <- factor(epistasis.temp.df2$second,levels=c("Pairwise",">2"))
  epistasis.temp.df2$`Term 2` <- factor(epistasis.temp.df2$`Term 2`,levels=c(nn.muts,"Higher"))
  epistasis.temp.df2$Antibody <- i
  assign(paste0("epistasis.biochem.df.all.",i),epistasis.temp.df2)
}
epistasis.biochem.df.all <- rbind(epistasis.biochem.df.all.CoV555,epistasis.biochem.df.all.S309,
                                  epistasis.biochem.df.all.CB6,epistasis.biochem.df.all.REGN10987)
```

```{r epistasis figure}
###Plot FIGURE 2A###
#just good ol linear effects
ggplot(biochem.first.order, aes(x=`Term 1`, y=Coefficient.nb, fill = Antibody))+
  geom_bar(stat='identity',color="#333333",position = position_dodge())+
  #geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
  #              position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_fill_manual(values=getPalettePairedLong(6)[2:5])+
  #scale_fill_manual(values = antibody.colors)+
  #scale_y_continuous(trans = squash_axis(5,95,10))+
  scale_y_continuous(breaks = c(-1.2,-1.05,-0.9,-0.6,-0.3,0,0.3,0.6),
                    labels = c("-4","-2.5","-1","-0.6","-0.3","0","0.3","0.6"),
  #                   trans = squash_axis(-0.8,-0.4,10)
                     )+
  #geom_segment(x=-2,xend=15,y=-0.3,yend=-0.3,size=0.5,color="white")+
  geom_hline(yintercept=-0.75,size=2,color="white")+
  xlab("Mutation") +
  ylab("Linear Effect") +
  theme_classic()+
  guides(fill = guide_legend(override.aes = list(size = 0.1)),
         color = guide_legend(override.aes = list(size = 0.1)))+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=10),
        legend.position = c(0.87,0.22),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        legend.key.size = unit(0.5, "lines"))

ggsave("figures/Figure2_bars_linear_effects_combined_with break.png", width = 4.5, height = 3.5, units = "in")

###Plot FIGURE 2B###
for (i in antibodies[1:3]) {
  epistasis.biochem.df2 <- subset(epistasis.biochem.df.all,Antibody==i)
  ggplot() + 
  geom_tile(data = subset(epistasis.biochem.df2,second =="Pairwise"),
            mapping=aes(x=`Term 1`, y=`Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-1.5,3.5),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  new_scale_fill()+
  geom_tile(data = subset(epistasis.biochem.df2,part %in% c("D")),
                          mapping=aes(`Term 1`, `Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-10,20),low ="#998ec3",
                       mid = "white",
                       high = "#f1a340",
                       midpoint = 0,
                       na.value = "#303030",
                       guide = "colorbar") +
  labs(fill="Higher \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=11,color="black"),
        #legend.text=element_text(size=12),
        legend.title=element_text(size=11,hjust = 1, vjust = 1),
        axis.title=element_text(size=13),
        legend.position="none",
        legend.spacing.x = unit(0, 'cm'))

  ggsave(paste0("figures/Figure2_heatmap_second_order_and_higher_orders_",i,".png"), width = 4, height = 4.1, units = "in")
}

### S309
epistasis.biochem.df2 <- subset(epistasis.biochem.df.all,Antibody=="S309")
ggplot() + 
  geom_tile(data = subset(epistasis.biochem.df2,second =="Pairwise"),
            mapping=aes(x=`Term 1`, y=`Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-0.6,0.6),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  new_scale_fill()+
  geom_tile(data = subset(epistasis.biochem.df2,part %in% c("D")),
                          mapping=aes(`Term 1`, `Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-1,1),low ="#998ec3",
                       mid = "white",
                       high = "#f1a340",
                       midpoint = 0,
                       na.value = "#303030",
                       guide = "colorbar") +
  labs(fill="Higher \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=10,color="black"),
        legend.text=element_text(size=7,hjust = 0.5, vjust = 0.5),
        legend.title=element_text(size=10,hjust = 0.5, vjust = 1),
        axis.title=element_text(size=13),
        legend.position="right",
        legend.key.size = unit(0.6, "lines"),
        strip.text = element_text(size = 8),
        strip.switch.pad.grid = unit(0.1,"cm"),
        legend.spacing.x = unit(0, 'cm'))

ggsave(paste0("figures/Figure2_heatmap_second_order_and_higher_orders_","S309",".png"), width = 4, height = 3.1, units = "in")

###REGN 10987
epistasis.biochem.df2 <- subset(epistasis.biochem.df.all,Antibody=="REGN10987")
ggplot() + 
  geom_tile(data = subset(epistasis.biochem.df2,second =="Pairwise"),
            mapping=aes(x=`Term 1`, y=`Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-2.2,2.2),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  new_scale_fill()+
  geom_tile(data = subset(epistasis.biochem.df2,part %in% c("D")),
            mapping=aes(`Term 1`, `Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-14,14),low ="#998ec3",
                       mid = "white",
                       high = "#f1a340",
                       midpoint = 0,
                       na.value = "#303030",
                       guide = "colorbar") +
  labs(fill="Higher \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=10,color="black"),
        legend.text=element_text(size=7,hjust = 0.5, vjust = 0.5),
        legend.title=element_text(size=10,hjust = 0.5, vjust = 1),
        axis.title=element_text(size=13),
        legend.position="right",
        legend.key.size = unit(0.6, "lines"),
        strip.text = element_text(size = 8),
        strip.switch.pad.grid = unit(0.1,"cm"),
        legend.spacing.x = unit(0, 'cm'))

ggsave(paste0("figures/Figure2_heatmap_second_order_and_higher_orders_","REGN10987",".png"), width = 4, height = 3.1, units = "in")

### CoV555
epistasis.biochem.df2 <- subset(epistasis.biochem.df.all,Antibody=="CoV555")
ggplot() + 
  geom_tile(data = subset(epistasis.biochem.df2,second =="Pairwise"),
            mapping=aes(x=`Term 1`, y=`Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-3.2,3.2),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  new_scale_fill()+
  geom_tile(data = subset(epistasis.biochem.df2,part %in% c("D")),
            mapping=aes(`Term 1`, `Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-19,19),low ="#998ec3",
                       mid = "white",
                       high = "#f1a340",
                       midpoint = 0,
                       na.value = "#303030",
                       guide = "colorbar") +
  labs(fill="Higher \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=10,color="black"),
        legend.text=element_text(size=7,hjust = 0.5, vjust = 0.5),
        legend.title=element_text(size=10,hjust = 0.5, vjust = 1),
        axis.title=element_text(size=13),
        legend.position="right",
        legend.key.size = unit(0.6, "lines"),
        strip.text = element_text(size = 8),
        strip.switch.pad.grid = unit(0.1,"cm"),
        legend.spacing.x = unit(0, 'cm'))

ggsave(paste0("figures/Figure2_heatmap_second_order_and_higher_orders_","CoV555",".png"), width = 4, height = 3.1, units = "in")

###CB6
epistasis.biochem.df2 <- subset(epistasis.biochem.df.all,Antibody=="CB6")
ggplot() + 
  geom_tile(data = subset(epistasis.biochem.df2,second =="Pairwise"),
            mapping=aes(x=`Term 1`, y=`Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-1.5,1.5),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  new_scale_fill()+
  geom_tile(data = subset(epistasis.biochem.df2,part %in% c("D")),
            mapping=aes(`Term 1`, `Term 2`, fill= `Coefficient.nb`)) +
  scale_fill_gradient2(limits = c(-2,2),low ="#998ec3",
                       mid = "white",
                       high = "#f1a340",
                       midpoint = 0,
                       na.value = "#303030",
                       guide = "colorbar") +
  labs(fill="Higher \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=10,color="black"),
        legend.text=element_text(size=7,hjust = 0.5, vjust = 0.5),
        legend.title=element_text(size=10,hjust = 0.5, vjust = 1),
        axis.title=element_text(size=13),
        legend.position="right",
        legend.key.size = unit(0.6, "lines"),
        strip.text = element_text(size = 8),
        strip.switch.pad.grid = unit(0.1,"cm"),
        legend.spacing.x = unit(0, 'cm'))

ggsave(paste0("figures/Figure2_heatmap_second_order_and_higher_orders_","CB6",".png"), width = 4, height = 3.1, units = "in")

###Plot FIGURE 2C-D###
first.structure$Term <- as.factor(first.structure$Term)
ggplot(first.structure, aes(`buriedSA`, `ACE2_Effect`, color= `Term`)) + 
  geom_point(size = 5.5) +
  scale_color_manual(values = getPalettePairedLong(15))+
  xlab(expression(paste("Contact Surface Area (",ring(A),{}^2,")"))) +
  ylab("Linear Effect") +
  labs(color='Linear Effect') +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  xlim(0,130)+
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=12,color="black"),
        legend.position = "none",
        axis.title=element_text(size=14))
ggsave("figures/Figure2_scatter_plot_linear_effect_vs_surface_area_withoutlabel_edit0504.png", width = 3, height = 3, units = "in")

ggplot(second.structure, aes(`distance`, `epistasis`, color= `epistasis`)) + 
  geom_point(size = 5) +
  scale_color_gradient2(limits = c(-.8,.8),low = brewer.pal(8,"Set1")[2],
                       mid = "#dedede",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0) +
  #geom_density(alpha=.2, fill="#FF6666") +
  xlab("Distance (\uc5)") +
  ylab("Pairwise Effect") +
  labs(color='Pairwise Effect') +
  #geom_text_repel(data=subset(second.structure,epistasis>0.3 | epistasis<(-0.15)),
  #          aes(distance,epistasis,label=labels),size=3.5,color="black")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=12,color="black"),
        legend.position = "none",
        #legend.text=element_text(size=12),
        #legend.title=element_blank(),
        axis.title=element_text(size=14))
ggsave("figures/Figure2_scatter_plot_pairwise_effect_vs_distance_withoutlabel_0504edit.png", width = 3, height = 3, units = "in")
```

```{r SI epistasis}

###Plot FIGURE 2A###
#just good ol linear effects
ggplot(subset(epistasis.stat,Order=="1"), aes(x=`Term 1`, y=Coefficient, fill = `Term 1`))+
  geom_bar(stat='identity',color="#333333")+
  geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
                position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_fill_manual(values = getPalettePairedLong(15))+
  xlab("Mutation") +
  ylab("Effect") +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        legend.position = "none")

ggsave("figures/FigureSI2_stat_bars_linear_effects_0504edit.png", width = 4.7, height = 2.8, units = "in")

###Plot FIGURE 2B###
#bunch of rearranging the terms and coefficients
summing_coefficient <- function(x,y){
  return(with(y, sum(Coefficient[
    rowSums(x[1] == y,na.rm=TRUE) > 0  &
      rowSums(x[2] == y,na.rm=TRUE) > 0])
  ))
}

summing_coefficient <- function(x,y){
  return(with(y, sum(Coefficient[
    rowSums(x[1] == y,na.rm=TRUE) > 0  &
      rowSums(x[2] == y,na.rm=TRUE) > 0])
  ))
}
abs_summing_coefficient <- function(x,y){
  return(with(y, sum(abs(Coefficient[
    rowSums(x[1] == y,na.rm=TRUE) > 0  &
      rowSums(x[2] == y,na.rm=TRUE) > 0]))
  ))
}

summing_coefficient_to_one <- function(x,y){
  return(with(y, sum(Coefficient[
    rowSums(x[1] == y,na.rm=TRUE) > 0 ])
  ))
}
epistasis.stat.higher <- subset(epistasis.stat,Order %in% c("3","4"))
epistasis.stat.temp <- subset(epistasis.stat,Order=="2")
epistasis.stat.temp$t1 <- epistasis.stat.temp$`Term 2`
epistasis.stat.temp$t2 <- epistasis.stat.temp$`Term 1`
epistasis.stat.temp$part <- "A"
epistasis.stat.temp$second <- "2"


epistasis.stat.temp2 <- epistasis.stat.temp
epistasis.stat.temp2$`Term 1` <- epistasis.stat.temp2$t1
epistasis.stat.temp2$`Term 2` <- epistasis.stat.temp2$t2
#epistasis.stat.temp2$`Coefficient`<- apply(epistasis.stat.temp2,1,summing_coefficient,y=epistasis.stat.higher)
epistasis.stat.temp2$part <- "B"
epistasis.stat.temp2$second <- "2"

epistasis.stat.temp3 <- subset(epistasis.stat,Order=="1")
epistasis.stat.temp3$`Term 2` <- epistasis.stat.temp3$`Term 1`
epistasis.stat.temp3$t1 <- NA
epistasis.stat.temp3$t2 <- NA
epistasis.stat.temp3$Coefficient <- NA
epistasis.stat.temp3$part <- "C"
epistasis.stat.temp3$second <- "2"

epistasis.stat.temp4 <- subset(epistasis.stat,Order=="1")
epistasis.stat.temp4$`Term 2` <- "Higher"
epistasis.stat.temp4$t1 <- NA
epistasis.stat.temp4$t2 <- NA
epistasis.stat.temp4$Coefficient <- apply(epistasis.stat.temp4,1,summing_coefficient_to_one,y=epistasis.stat.higher)
epistasis.stat.temp4$part <- "D"
epistasis.stat.temp4$second <- ">2"

epistasis.stat.df2 <- rbind(epistasis.stat.temp,epistasis.stat.temp2,epistasis.stat.temp3,epistasis.stat.temp4)
epistasis.stat.df2$second <- factor(epistasis.stat.df2$second,levels=c("2",">2"))
epistasis.stat.df2$`Term 2` <- factor(epistasis.stat.df2$`Term 2`,levels=c(nn.muts,"Higher"))

ggplot() + 
  geom_tile(data = subset(epistasis.stat.df2,second =="2"),
            mapping=aes(x=`Term 1`, y=`Term 2`, fill= `Coefficient`)) +
  scale_fill_gradient2(limits = c(-0.1,0.1),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  new_scale_fill()+
  geom_tile(data = subset(epistasis.stat.df2,part %in% c("D")),
                          mapping=aes(`Term 1`, `Term 2`, fill= `Coefficient`)) +
  scale_fill_gradient2(limits = c(-0.1,0.1),low ="#998ec3",
                       mid = "white",
                       high = "#f1a340",
                       midpoint = 0,
                       na.value = "#303030",
                       guide = "colorbar") +
  labs(fill="Higher \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        #legend.text=element_text(size=12),
        legend.title=element_text(size=11,hjust = 1, vjust = 1),
        axis.title=element_text(size=14),
        legend.position="bottom",
        legend.spacing.x = unit(0, 'cm'),
        legend.text = element_text(size=8,hjust=0.6))

ggsave("figures/FigureSI2_stat_heatmap_second_order_and_higher_orders_0506edit.png", width = 4.7, height = 5.3, units = "in")

###Plot FIGURE 2C-D###
first.structure$Term <- as.factor(first.structure$Term)
ggplot(first.structure, aes(`buriedSA`, `ACE2_Effect`, color= `Term`)) + 
  geom_point(size = 5.5) +
  scale_color_manual(values = getPalettePairedLong(15))+
  xlab(expression(paste("Contact Surface Area (",ring(A),{}^2,")"))) +
  ylab("Linear Effect") +
  labs(color='Linear Effect') +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  xlim(0,130)+
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=12,color="black"),
        legend.position = "none",
        axis.title=element_text(size=14))
ggsave("figures/FigureSI2_stat_scatter_plot_linear_effect_vs_surface_area_withoutlabel_edit0504.png", width = 3, height = 3, units = "in")

ggplot(second.structure, aes(`distance`, `epistasis`, color= `epistasis`)) + 
  geom_point(size = 5) +
  scale_color_gradient2(limits = c(-.8,.8),low = brewer.pal(8,"Set1")[2],
                       mid = "#dedede",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0) +
  #geom_density(alpha=.2, fill="#FF6666") +
  xlab("Distance (\uc5)") +
  ylab("Pairwise Effect") +
  labs(color='Pairwise Effect') +
  #geom_text_repel(data=subset(second.structure,epistasis>0.3 | epistasis<(-0.15)),
  #          aes(distance,epistasis,label=labels),size=3.5,color="black")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=12,color="black"),
        legend.position = "none",
        #legend.text=element_text(size=12),
        #legend.title=element_blank(),
        axis.title=element_text(size=14))
ggsave("figures/FigureSI2_stat_scatter_plot_pairwise_effect_vs_distance_withoutlabel_0504edit.png", width = 3, height = 3, units = "in")
```

```{r epistasis regression exploration}

require(ggplot2)
require(GGally)
require(VGAM)
Kds_simplified[paste0('Mutation_', nn)] <- Kds_simplified[paste0('Mutation ', nn)]
Kds_simplified[nn.muts] <- Kds_simplified[paste0('Mutation ', nn)]
Kds.abs <- subset(Kds_simplified,Antibody=="CoV555")
Kds.abs.CoV555 <- subset(Kds_simplified,Antibody=="CoV555")
Kds.abs.S309 <- subset(Kds_simplified,Antibody=="S309")
Kds.abs.CB6 <- subset(Kds_simplified,Antibody=="CB6")
Kds.abs.REGN10987 <- subset(Kds_simplified,Antibody=="REGN10987")


Kds.abs.genos.phenos <- Kds.abs[,c(2,21:35)]
fmla <- as.formula(paste("Log10Kd ~ ", paste(paste0('Mutation_', nn),collapse= "+")))
linear.comb <- paste(paste0('Mutation_', nn),collapse= "+")
fmla.2 <- as.formula(paste0("Log10Kd ~ (",linear.comb,")^2"))
fmla.4 <- as.formula(paste0("Log10Kd ~ (",linear.comb,")^4"))
m2 <- vglm(fmla.2, tobit(Lower = 6, imethod = 2), data = Kds.abs)
m2.old <- glm(fmla.2,  data = Kds.abs)
m2.coefs <- as.vector(coef(m2))
m2.old.coefs <- as.vector(coef(m2.old))
m2.old.coefs <- c(m2.old.coefs[1],NA,m2.old.coefs[2:length(m2.old.coefs)])
combo <- t(combn(nn.muts,2))
Second.Coefficient.comparison <- data.frame(Terms1 = c("Intercept.1","Intercept.2",nn.muts,combo[,1]),
                                            Terms2 = c(rep(NA,17),combo[,2]),
                                            Regular = m2.old.coefs,
                                            Tobit = m2.coefs,
                                            Order = c(rep("None",2),rep(1,15),rep(2,105)))
Second.Coefficient.comparison.muts.only <- Second.Coefficient.comparison[-(1:2),]
Second.Coefficient.comparison.muts.only$Terms1 <- factor(Second.Coefficient.comparison.muts.only$Terms1,levels=nn.muts)
Second.Coefficient.comparison.muts.only$Terms2 <- factor(Second.Coefficient.comparison.muts.only$Terms2,levels=nn.muts)
Second.Coefficient.comparison.muts.only.1 <- subset(Second.Coefficient.comparison.muts.only,Order == 1)
Second.Coefficient.comparison.muts.only.1.long <- reshape(Second.Coefficient.comparison.muts.only.1, 
                                                 varying=c("Tobit", "Regular"),
                                                 direction="long", 
                                                 idvar=c("Terms1"),
                                                 v.names="Coefficient",
                                                 timevar = "Method")
Second.Coefficient.comparison.muts.only.1.long$Method <- as.factor(Second.Coefficient.comparison.muts.only.1.long$Method)
levels(Second.Coefficient.comparison.muts.only.1.long$Method) <- c("Tobit","Regular")

####ANOTHER MODEL
#m4 <- vglm(fmla.4, tobit(Lower = 6, imethod = 2), data = Kds.abs)
#m4.old <- glm(fmla.4,  data = Kds.abs)
#summary(m <- vglm(fmla, tobit(Lower = 6), data = Kds.abs))
#m.old <- glm(fmla,data=Kds.abs)
#m.coefs <- as.vector(coef(m))[-2]
#m.old.coefs <- as.vector(coef(m.old))
Coefficient.comparison <- data.frame(Terms = c("Intercept",nn.muts),
                                     Regular = m.old.coefs,
                                     Tobit = m.coefs)
Coefficient.comparison.muts.only <- Coefficient.comparison[-1,]
Coefficient.comparison.muts.only$Terms <- factor(Coefficient.comparison.muts.only$Terms,levels=nn.muts)
Coefficient.comparison.muts.only.long <- reshape(Coefficient.comparison.muts.only, 
                                                 varying=c("Tobit", "Regular"),
                                                 direction="long", 
                                                 idvar=c("Terms"),
                                                 v.names="Coefficient",
                                                 timevar = "Method")
Coefficient.comparison.muts.only.long$Method <- as.factor(Coefficient.comparison.muts.only.long$Method)
levels(Coefficient.comparison.muts.only.long$Method) <- c("Tobit","Regular")
####

ggplot(Second.Coefficient.comparison.muts.only.1, aes(Regular, Tobit, color=Terms1)) + 
  geom_point(size = 5) +
  scale_color_manual(values=getPalettePairedLong(15))+
  #geom_density(alpha=.2, fill="#FF6666") +
  xlab("OLS Coeffficnet") +
  ylab("Tobit Coefficient") +
  #labs(color='Pairwise Effect') +
  #geom_text_repel(data=subset(second.structure,epistasis>0.3 | epistasis<(-0.15)),
  #          aes(distance,epistasis,label=labels),size=3.5,color="black")+
  theme_classic()+
  geom_abline()+
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=12,color="black"),
        legend.position = "none",
        #legend.text=element_text(size=12),
        #legend.title=element_blank(),
        axis.title=element_text(size=14))
ggsave("figures/FigureSI_tobit_ols_comparison_smaller_pairwise_CoV555.png", width = 4, height = 4, units = "in")


ggplot(Coefficient.comparison.muts.only.long, aes(x=Terms, y=Coefficient, fill = Method))+
  geom_bar(stat='identity',color="#333333",position = position_dodge())+
  #geom_errorbar(aes(ymin=Coefficient-Standard.Error, ymax=Coefficient+Standard.Error), width=.6,
  #              position=position_dodge(.9), colour = "#969696",size=0.7) +
  scale_fill_manual(values = antibody.colors)+
  #geom_hline(yintercept=50,size=0.5,linetype = "dashed",color="black")+
  xlab("Mutation") +
  ylab(str_wrap("Coefficient", width = 30)) +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        legend.text=element_text(size=12),
        legend.title=element_blank(),
        axis.title=element_text(size=14),
        axis.title.y=element_text(size=12))

ggsave("figures/FigureSI_linear_coefs_tobit_regular.png", width = 10, height = 5, units = "in")

###Pairwise
Second.Coefficient.pairwise <- Second.Coefficient.comparison.muts.only
Second.Coefficient.pairwise[1:15,]$Terms2 <- nn.muts
Second.Coefficient.pairwise$Regular <- ifelse(Second.Coefficient.pairwise$Terms1==Second.Coefficient.pairwise$Terms2,
                                              NA,
                                              Second.Coefficient.pairwise$Regular)
Second.Coefficient.pairwise$Tobit <- ifelse(Second.Coefficient.pairwise$Terms1==Second.Coefficient.pairwise$Terms2,
                                              NA,
                                              Second.Coefficient.pairwise$Tobit)
temp <- subset(Second.Coefficient.pairwise,Order==2)
t <- temp$Terms1
temp$Terms1 <- temp$Terms2
temp$Terms2 <- t
Second.Coefficient.pairwise <- rbind(Second.Coefficient.pairwise,temp)
Second.Coefficient.pairwise$Terms1 <- factor(Second.Coefficient.pairwise$Terms1,levels=nn.muts)
Second.Coefficient.pairwise$Terms2 <- factor(Second.Coefficient.pairwise$Terms2,levels=nn.muts)
ggplot() + 
  geom_tile(data = Second.Coefficient.pairwise,
            mapping=aes(x=`Terms1`, y=`Terms2`, fill= `Tobit`)) +
  scale_fill_gradient2(limits = c(-3.1,2.4),low = brewer.pal(8,"Set1")[2],
                       mid = "white",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 0,
                       guide = "colorbar") + 
  labs(fill="Second \nOrder ")+
  xlab("Mutation 1") +
  ylab("Mutation 2") +
  theme_classic()+
  #facet_grid(rows=vars(second),scales="free",space="free_y")+
  theme(axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5),
        axis.text=element_text(size=12,color="black"),
        #legend.text=element_text(size=12),
        legend.title=element_text(size=11,hjust = 1, vjust = 1),
        axis.title=element_text(size=14),
        legend.position="bottom",
        legend.spacing.x = unit(0, 'cm'),
        legend.text = element_text(size=8,hjust=0.6))

ggsave("figures/FigureSI2_stat_heatmap_second_order_tobit_CoV555.png", width = 4.7, height = 5.3, units = "in")
```

```{r more epistais predictions}

ggplot(Kds.abs, aes(Log10Kd, Predicted.Tobit.Latent, color=Mutation_417)) + 
  geom_point(size = 1) +
  #geom_density(alpha=.2, fill="#FF6666") +
  xlab("Actual -LogKd") +
  ylab("Predicted -LogKd") +
  #labs(color='Pairwise Effect') +
  #geom_text_repel(data=subset(second.structure,epistasis>0.3 | epistasis<(-0.15)),
  #          aes(distance,epistasis,label=labels),size=3.5,color="black")+
  theme_classic()+
  
  ylim(-1,10.8)+
  geom_abline()+
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=12,color="black"),
        legend.position = "none",
        #legend.text=element_text(size=12),
        #legend.title=element_blank(),
        axis.title=element_text(size=14))
ggsave("figures/FigureSI_regular_tobit_predicted_vs_actual.png", width = 4, height = 4, units = "in")

```
## Figure 4 - Comparison with ACE2 Data
###Trade-offs
```{r tradeoffs}
library(Rtsne)
library(plotly)
Kds.short.tradeoff[paste0("Mutation_",nn)] <- Kds_simplified[1:32768,paste0("Mutation ",nn)]
Kds.short.tradeoff$Mean_Ab <- rowMeans(Kds.short.tradeoff[,3:6])
Kds.short.tradeoff$Mean_Ab <- rowMeans(Kds.short.tradeoff[,3:6])
Kds.short.tradeoff$Max_Ab <- apply(Kds.short.tradeoff[,3:6],1,max)
Kds.short.tradeoff$Max_Ab_which <- ifelse(Kds.short.tradeoff$Max_Ab==Kds.short.tradeoff$CB6,
                                          "CB6",
                                          ifelse(Kds.short.tradeoff$Max_Ab==Kds.short.tradeoff$CoV555,
                                                 "CoV555",
                                                 ifelse(Kds.short.tradeoff$Max_Ab==Kds.short.tradeoff$REGN10987,
                                                        "REGN10987",
                                                        "S309"
                                                 )))
Kds.short.tradeoff$Max_Ab_which <- factor(Kds.short.tradeoff$Max_Ab_which,levels=antibodies)
corr1 <- cor(Kds.short.tradeoff$Max_Ab,Kds.short.tradeoff$ACE2)^2
corr2 <- cor(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0")$Max_Ab,
             subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0")$ACE2)^2

Kds.short.tradeoff$Mut498_501 <- interaction(
               Kds.short.tradeoff$`Mutation_498`,Kds.short.tradeoff$`Mutation_501`,sep="",lex.order=TRUE)

Kds.short.tradeoff2 <- Kds.short.tradeoff
Kds.short.tradeoff2$ACE2 <- ifelse(Kds.short.tradeoff2$ACE2 < 6, NA,Kds.short.tradeoff2$ACE2)
Kds.short.tradeoff2$CB6 <- ifelse(Kds.short.tradeoff2$CB6 < 6, NA,Kds.short.tradeoff2$CB6)
Kds.short.tradeoff2$CoV555 <- ifelse(Kds.short.tradeoff2$CoV555 < 6, NA,Kds.short.tradeoff2$CoV555)
Kds.short.tradeoff2$REGN10987 <- ifelse(Kds.short.tradeoff2$REGN10987 < 6, NA,Kds.short.tradeoff2$REGN10987)
Kds.short.tradeoff2$S309 <- ifelse(Kds.short.tradeoff2$S309 < 6, NA,Kds.short.tradeoff2$S309)

for(i in 1:4){
  for(j in 5:5){
    for(k in 1:4){
    ab1 <- c(antibodies,"ACE2")[i]
    ab2 <- c(antibodies,"ACE2")[j]
    sab1 <- ifelse(ab1=="CB6","LY-CoV016",
                   ifelse(ab1=="CoV555","LY-CoV555",ab1))
    mut <- levels(Kds.short.tradeoff$Mut498_501)[k]
    Kds.tradeoff.considered <- subset(Kds.short.tradeoff,Mut498_501==mut)
    #Kds.tradeoff.considered <- subset(Kds.tradeoff.considered,ab1>5)
    print(round(cor(Kds.tradeoff.considered[,ab1],Kds.tradeoff.considered[,ab2], use="complete.obs"),2))
    }
  }
}


for(i in 1:4){
  for(j in 5:5){
    ab1 <- c(antibodies,"ACE2")[i]
    ab2 <- c(antibodies,"ACE2")[j]
    sab1 <- ifelse(ab1=="CB6","LY-CoV016",
                   ifelse(ab1=="CoV555","LY-CoV555",ab1))
    correlation00 <- round(cor(subset(Kds.short.tradeoff2,Mut498_501=="00")[,ab1],
                             subset(Kds.short.tradeoff2,Mut498_501=="00")[,ab2], use="complete.obs"),2)
    correlation11 <- round(cor(subset(Kds.short.tradeoff2,Mut498_501=="11")[,ab1],
                             subset(Kds.short.tradeoff2,Mut498_501=="11")[,ab2], use="complete.obs"),2)
    Kds.template <- Kds.short.tradeoff
    Kds.template$Ab1 <- Kds.short.tradeoff[,ab1]
    Kds.template$Ab2 <- Kds.short.tradeoff[,ab2]
    ggplot(Kds.template,aes(x=Ab1,y=Ab2))+
      #ggplot(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0"),aes(x=ACE2,y=Max_Ab,color=Max_Ab_which))+
      #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
      #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
      #              colour = "#969696",size=0.5,alpha=0.5)+
      geom_point(size = 0.5 ,alpha=0.5,aes(color=interaction(
               `Mutation_498`,`Mutation_501`,sep="/",lex.order=TRUE)))+
      scale_color_manual(values=getPalettePairedLong(6)[2:5]) +
      scale_x_continuous(breaks=c(5,6:11),labels=c("NB",6:11))+
      scale_y_continuous(breaks=c(5,6:11),labels=c("NB",6:11))+
      #geom_smooth(method='lm',color="black")+
      geom_richtext(data = legends,
                    mapping = aes(x = 5, 
                                  y = 10.2, 
                                  label = paste0("r = ",correlation00)
                                  ),
                    hjust=0,
                    color = getPalettePairedLong(6)[2],
                    size=3.5,
                    #label.padding=unit(c(0,0,0,0),"lines"),
                    fill = NA,
                    label.color = NA)+
      geom_richtext(data = legends,
                    mapping = aes(x = 5, 
                                  y = 9.8, 
                                  label = paste0("r = ",correlation11)
                                  ),
                    hjust=0,
                    color = getPalettePairedLong(6)[5],
                    size=3.5,
                    #label.padding=unit(c(0,0,0,0),"lines"),
                    fill = NA,
                    label.color = NA)+
      #scale_color_manual(values = getPalettePairedLong(15))+
      
      labs(x=bquote(.(sab1)~(-log~italic(K)[paste("D", ",", "app")])),
           y=bquote(.(ab2)~(-log~italic(K)[paste("D", ",", "app")])),
           color = "Antibody") +
      #geom_text_repel(data=subset(first.structure,buriedSA>0),
      #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
      theme_classic()+
      #xlim(6,10.5)+
      #xlim(0,130)+
      #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
      guides(colour = guide_legend(override.aes = list(size=3)))+
      theme(
            axis.text=element_text(size=12,color="black"),
            axis.text.x = element_text(size=10,angle = 0),
            axis.text.y = element_text(size=10),
            legend.position = "none",
            legend.text=element_text(size=10),
            #legend.title=element_blank(),
            legend.key.size = unit(0.5, "lines"),
            axis.title.y=element_text(size=11),
            axis.title.x=element_text(size=10.5),
            legend.spacing = unit(4, "pt"), 
            legend.key.height = unit(8, "pt"), 
            legend.spacing.x = unit(4, "pt"), 
            legend.key.width  = unit(4, "pt"), 
            legend.margin=margin(4,4,4,4),
            legend.title = element_text(size=11))
    ggsave(paste0("figures/FigureSI_dot_plots_tradeoff_",ab1,"_",ab2,".png"),
           width = 2.2, height = 2.2, units = "in")
  }
}

for(i in 1:3){
  for(j in (i+1):4){
    ab1 <- c(antibodies,"ACE2")[i]
    ab2 <- c(antibodies,"ACE2")[j]
    print(round(cor(Kds.short.tradeoff[,ab1],Kds.short.tradeoff[,ab2], use="complete.obs"),2))
  }
}

for(i in 1:3){
  for(j in (i+1):4){
    ab1 <- c(antibodies,"ACE2")[i]
    ab2 <- c(antibodies,"ACE2")[j]
    correlation <- round(cor(Kds.short.tradeoff[,ab1],Kds.short.tradeoff[,ab2], use="complete.obs")^2,2)
    Kds.template <- Kds.short.tradeoff
    Kds.template$Ab1 <- Kds.short.tradeoff[,ab1]
    Kds.template$Ab2 <- Kds.short.tradeoff[,ab2]
    ggplot(Kds.template,aes(x=Ab1,y=Ab2))+
      #ggplot(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0"),aes(x=ACE2,y=Max_Ab,color=Max_Ab_which))+
      #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
      
      +
      #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
      #              colour = "#969696",size=0.5,alpha=0.5)+
      geom_point(size = 0.5 ,alpha=0.5,color="black")+
      scale_color_manual(values=getPalettePairedLong(6)[2:5]) +
      geom_smooth(method='lm',color="black")+
      geom_richtext(data = legends,
                    mapping = aes(x = 6.1, 
                                  y = 10.1, 
                                  label = paste0("R<sup>2</sup> = ",correlation)
                                  ),
                    hjust=0,
                    size=3.5,
                    #label.padding=unit(c(0,0,0,0),"lines"),
                    fill = NA,
                    label.color = NA)+
      #scale_color_manual(values = getPalettePairedLong(15))+
      labs(x=expression(paste(ab1,(-log~italic(K)[paste("D", ",", "app")]))),
           y=expression(paste(ab2,(-log~italic(K)[paste("D", ",", "app")]))),
           color = "Antibody") +
      #geom_text_repel(data=subset(first.structure,buriedSA>0),
      #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
      theme_classic()+
      #xlim(6,10.5)+
      #xlim(0,130)+
      #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
      guides(colour = guide_legend(override.aes = list(size=3)))+
      theme(
            axis.text=element_text(size=12,color="black"),
            axis.text.x = element_text(size=14,angle = -1),
            axis.text.y = element_text(size=12),
            legend.position = "none",
            legend.text=element_text(size=10,vjust=1),
            #legend.title=element_blank(),
            legend.key.size = unit(0.5, "lines"),
            axis.title=element_text(size=14),
            legend.spacing = unit(4, "pt"), 
            legend.key.height = unit(8, "pt"), 
            legend.spacing.x = unit(4, "pt"), 
            legend.key.width  = unit(4, "pt"), 
            legend.margin=margin(4,4,4,4),
            legend.title = element_text(size=11))
    #ggsave(paste0("figures/FigureSI_dot_plots_tradeoff_",ab1,"_",ab2,".png"),width = 2.2, height = 2.2, units = "in")
  }
}


ggplot(Kds.short.tradeoff,aes(x=S309,y=ACE2))+
#ggplot(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0"),aes(x=ACE2,y=Max_Ab,color=Max_Ab_which))+
  #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
  geom_point(size = 0.5 ,alpha=0.5,aes(color=interaction(
    `Mutation_498`,`Mutation_501`,sep="/",lex.order=TRUE))) +
  #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
  #              colour = "#969696",size=0.5,alpha=0.5)+
  scale_color_manual(values=getPalettePairedLong(6)[2:5]) +
  geom_smooth(method='lm',color="black")+
  geom_richtext(data = legends,
                mapping = aes(x = 6.1, 
                              y = 10.6, 
                              label = paste0("R<sup>2</sup> = ",
                                             round(cor(Kds.short.tradeoff$S309,
                                                       Kds.short.tradeoff$ACE2)^2,2))
                              ),
                hjust=0,
                size=3.5,
                #label.padding=unit(c(0,0,0,0),"lines"),
                fill = NA,
                label.color = NA)+
  #scale_color_manual(values = getPalettePairedLong(15))+
  labs(x=expression(paste("ACE2 ",(-log~italic(K)[paste("D", ",", "app")]))),
       y=expression(paste("Max mAb ",(-log~italic(K)[paste("D", ",", "app")]))),
       color = "Antibody") +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  xlim(6,10.5)+
  #xlim(0,130)+
  #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
  guides(colour = guide_legend(override.aes = list(size=3)))+
  theme(
        axis.text=element_text(size=12,color="black"),
        axis.text.x = element_text(size=14,angle = 0),
        axis.text.y = element_text(size=12),
        legend.position = "right",
        legend.text=element_text(size=10),
        #legend.title=element_blank(),
        legend.key.size = unit(0.5, "lines"),
        axis.title=element_text(size=14),
        legend.spacing = unit(4, "pt"), 
        legend.key.height = unit(8, "pt"), 
        legend.spacing.x = unit(4, "pt"), 
        legend.key.width  = unit(4, "pt"), 
        legend.margin=margin(4,4,4,4),
        legend.title = element_text(size=11))


ggplot(Kds.template,aes(x=Ab1,y=Ab2))+
    #ggplot(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0"),aes(x=ACE2,y=Max_Ab,color=Max_Ab_which))+
    #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
    #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
    #              colour = "#969696",size=0.5,alpha=0.5)+
    geom_point(size = 0.5 ,alpha=0.5,aes(color=interaction(
             `Mutation_498`,`Mutation_501`,sep="/",lex.order=TRUE)))+
    scale_color_manual(labels=c("0/0" = "Q498/N501", 
                            "1/0" = "R498/N501",
                            "0/1" = "Q498/Y501",
                            "1/1" = "R498/Y501"),
                       values=getPalettePairedLong(6)[2:5]) +
    scale_x_continuous(breaks=c(5,6:11),labels=c("NB",6:11))+
    scale_y_continuous(breaks=c(5,6:11),labels=c("NB",6:11))+
    geom_smooth(method='lm',color="black")+
    geom_richtext(data = legends,
                  mapping = aes(x = 5.2, 
                                y = 10.2, 
                                label = paste0("r = ",correlation)
                                ),
                  hjust=0,
                  size=3.5,
                  #label.padding=unit(c(0,0,0,0),"lines"),
                  fill = NA,
                  label.color = NA)+
    #scale_color_manual(values = getPalettePairedLong(15))+
    
    labs(x=bquote(.(sab1)~-log~italic(K)[paste("D", ",", "app")]),
         y=bquote(.(ab2)~-log~italic(K)[paste("D", ",", "app")]),
         color = "") +
    #geom_text_repel(data=subset(first.structure,buriedSA>0),
    #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
    theme_classic()+
    #xlim(6,10.5)+
    #xlim(0,130)+
    #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
    guides(colour = guide_legend(override.aes = list(size=3),ncol=1,byrow=TRUE))+
    theme(
          axis.text=element_text(size=12,color="black"),
          axis.text.x = element_text(size=10,angle = 0),
          axis.text.y = element_text(size=10),
          legend.position = "bottom",
          legend.text=element_text(size=12,vjust=0.4),
          #legend.title=element_blank(),
          legend.key.size = unit(1, "lines"),
          axis.title=element_text(size=11),
          legend.spacing.y = unit(6,"pt"), 
          legend.key.height = unit(4, "pt"), 
          legend.key.width  = unit(4, "pt"), 
          legend.margin=margin(6,6,6,6),
          legend.title = element_text(size=11))
ggsave(paste0("figures/FigureSI_dot_plots_tradeoff_legend.png"),
       width = 8.8, height = 4, units = "in")

```

```{r max abs}
library(ggtext)
ggplot(Kds.short.tradeoff,aes(x=ACE2,y=Max_Ab))+
#ggplot(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0"),aes(x=ACE2,y=Max_Ab,color=Max_Ab_which))+
  #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
  geom_point(size = 0.5 ,alpha=0.5,aes(color=Max_Ab_which)) +
  #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
  #              colour = "#969696",size=0.5,alpha=0.5)+
  scale_color_manual(values=getPalettePairedLong(6)[2:5]) +
  geom_smooth(method='lm',color="black")+
  geom_richtext(data = legends,
                mapping = aes(x = 6.1, 
                              y = 10.6, 
                              label = paste0("R<sup>2</sup> = ",round(corr1,2))
                              ),
                hjust=0,
                size=3.5,
                #label.padding=unit(c(0,0,0,0),"lines"),
                fill = NA,
                label.color = NA)+
  #scale_color_manual(values = getPalettePairedLong(15))+
  labs(x=expression(paste("ACE2 ",(-log~italic(K)[paste("D", ",", "app")]))),
       y=expression(paste("Max mAb ",(-log~italic(K)[paste("D", ",", "app")]))),
       color = "Antibody") +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  xlim(6,10.5)+
  #xlim(0,130)+
  #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
  guides(colour = guide_legend(override.aes = list(size=3)))+
  theme(
        axis.text=element_text(size=12,color="black"),
        axis.text.x = element_text(size=14,angle = 0),
        axis.text.y = element_text(size=12),
        legend.position = "right",
        legend.text=element_text(size=10),
        #legend.title=element_blank(),
        legend.key.size = unit(0.5, "lines"),
        axis.title=element_text(size=14),
        legend.spacing = unit(4, "pt"), 
        legend.key.height = unit(8, "pt"), 
        legend.spacing.x = unit(4, "pt"), 
        legend.key.width  = unit(4, "pt"), 
        legend.margin=margin(4,4,4,4),
        legend.title = element_text(size=11))
ggsave("figures/FigureSI_dot_plots_tradepff_max_edit0729.png", width = 4.2, height = 2.7, units = "in")
#ggsave("figures/FigureSI_dot_plots_tradepff_max_without498_501.png", width = 3.3, height = 2.7, units = "in")

#without compen
ggplot(subset(Kds.short.tradeoff,Mutation_501=="0"&Mutation_498=="0"),aes(x=ACE2,y=Max_Ab))+
  #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
  geom_point(size = 0.5 ,alpha=0.5,aes(color=Max_Ab_which)) +
  #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
  #              colour = "#969696",size=0.5,alpha=0.5)+
  scale_color_manual(values=getPalettePairedLong(6)[2:5]) +
  geom_smooth(method='lm',color="black")+
  geom_richtext(data = legends,
                mapping = aes(x = 6.1, 
                              y = 10.6, 
                              label = paste0("R<sup>2</sup> = ",round(corr2,2))
                              ),
                hjust=0,
                size=3.5,
                #label.padding=unit(c(0,0,0,0),"lines"),
                fill = NA,
                label.color = NA)+
  #scale_color_manual(values = getPalettePairedLong(15))+
  labs(x=expression(paste("ACE2 ",(-log~italic(K)[paste("D", ",", "app")]))),
       y=expression(paste("Max mAb ",(-log~italic(K)[paste("D", ",", "app")]))),
       color = "Antibody") +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  xlim(6,9.5)+
  #xlim(0,130)+
  #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
  guides(colour = guide_legend(override.aes = list(size=3)))+
  theme(
        axis.text=element_text(size=10,color="black"),
        axis.text.x = element_text(size=12,angle = 0),
        axis.text.y = element_text(size=12),
        legend.position = "none",
        axis.title=element_text(size=14))
ggsave("figures/FigureSI_dot_plots_tradepff_max_without498_501.png", width = 2.4, height = 2.7, units = "in")


Kds.tradeoff.just.phenos <- Kds.short.tradeoff[,3:6]
Kds.tradeoff.just.phenos$ACE2 <- ifelse(is.na(Kds.tradeoff.just.phenos$ACE2),6.0,Kds.tradeoff.just.phenos$ACE2)
set.seed(142)

tsne.data <- Rtsne(Kds.tradeoff.just.phenos)
Kds.short.tradeoff$tSNE1 <- tsne.data$Y[,1]
Kds.short.tradeoff$tSNE2 <- tsne.data$Y[,2]
Kds.short.tradeoff$ACE2 <- ifelse(is.na(Kds.short.tradeoff$ACE2),7.0,Kds.short.tradeoff$ACE2)


ggplot(Kds.short.tradeoff,aes(x=CB6,y=ACE2))+
  #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
  geom_point(size = 1 ,alpha=0.5) +
  #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
  #              colour = "#969696",size=0.5,alpha=0.5)+
  #scale_color_manual(values = getPalettePairedLong(15))+
  labs(x="S309",
       y="ACE2") +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  #xlim(0,130)+
  #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
  guides(color=guide_legend(ncol=2))+
  theme(
        axis.text=element_text(size=10,color="black"),
        axis.text.x = element_text(size=12,angle = 0),
        axis.text.y = element_text(size=12),
        legend.position = "none",
        axis.title=element_text(size=14),
        legend.text = element_text(size=10),
        legend.title = element_text(size=11))

###compared to ACE2
ggplot(Kds.short.tradeoff,aes(x=tSNE1,y=tSNE2,color=ACE2))+
  #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
  geom_point(size = 0.5 ,alpha=0.5) +
  #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
  #              colour = "#969696",size=0.5,alpha=0.5)+
  #scale_color_gradient2(limits = c(6.7,10.1),low = brewer.pal(8,"Set1")[2],
  #                     mid = "#dedede",
  #                     high = brewer.pal(8,"Set1")[1],
  #                     midpoint = 8.6)+
  labs(x="ACE2",
       y="tSNE-2",
       color="Affinity\nto ACE2") +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  #xlim(0,130)+
  #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
  theme(
        axis.text=element_text(size=10,color="black"),
        axis.text.x = element_text(size=11,angle = 0),
        axis.text.y = element_text(size=11),
        legend.position = "bottom",
        axis.title=element_text(size=12),
        legend.text = element_text(size=9),
        legend.title = element_text(size=10,vjust=1))
ggsave("figures/Figure4_tsne_ACE2.png", width = 2.8, height = 3.2, units = "in")


###Mean Plot
Kds.short.tradeoff$Mean_Ab <- rowMeans(Kds.short.tradeoff[,3:6])
ggplot(Kds.short.tradeoff,aes(x=tSNE1,y=tSNE2,color=Mean_Ab))+
  #geom_line(aes(color= `Mutation`),size=1.25,alpha=0.8)+
  geom_point(size = 0.5 ,alpha=0.5) +
  #geom_errorbar(aes(ymin=`KD Effect`-STE, ymax=`KD Effect`+STE),color="black",width=0.0003,
  #              colour = "#969696",size=0.5,alpha=0.5)+
  scale_color_gradient2(limits = c(6.6,10),low = brewer.pal(8,"Set1")[2],
                       mid = "#dedede",
                       high = brewer.pal(8,"Set1")[1],
                       midpoint = 8.3)+
  labs(x="tSNE-1",
       y="tSNE-2",
       color="Mean Affinity\nto Antibodies") +
  #geom_text_repel(data=subset(first.structure,buriedSA>0),
  #          aes(buriedSA-3.5,ACE2_Effect+.1,label=Term),size=4,color="black")+
  theme_classic()+
  #xlim(0,130)+
  #geom_hline(yintercept = 0 , colour = "black", linetype = "dashed")+
  theme(
        axis.text=element_text(size=10,color="black"),
        axis.text.x = element_text(size=11,angle = 0),
        axis.text.y = element_text(size=11),
        legend.position = "bottom",
        axis.title=element_text(size=12),
        legend.text = element_text(size=9),
        legend.title = element_text(size=10,vjust=1))
ggsave("figures/Figure4_tsne_mean_ab.png", width = 2.8, height = 3.2, units = "in")
```

```{r plotly}
# Point colors
#Kds.short.tradeoff$ACE2 <- ifelse((Kds.short.tradeoff$ACE2)<7,7,Kds.short.tradeoff$ACE2)
marker <- list(color = ~ACE2, colorscale = 'Hot', 
              showscale = TRUE,opacity=.7,size=5
              )
# Create the plot
p <- plot_ly(Kds.short.tradeoff, x = ~jitter(CB6,1), y = ~jitter(CoV555,1), z = ~jitter(REGN10987,1), marker = marker) %>%
  add_markers() %>%
  layout(
    scene = list(xaxis = list(title = 'CB6'),
        yaxis = list(title = 'CoV555'),
        zaxis = list(title = 'REGN10987'))
        )
p
```



```{r pca}
library(ggplot2)
Kds.short.tradeoff$ACE2 <- ifelse(is.na(Kds.short.tradeoff$ACE2),6,Kds.short.tradeoff$ACE2)
pca_res <- prcomp(Kds.short.tradeoff[3:6], scale. = TRUE)
Kds.short.tradeoff[paste0("Mutation_",nn.muts)] <- Kds_simplified[paste0("Mutation_",nn)] 
p <- autoplot(pca_res, data = Kds.short.tradeoff, colour = 'ACE2',size=0.1,loadings = TRUE,loadings.colour = 'blue',loadings.label = TRUE, loadings.label.size = 3)
p
ggplotly(p)
```